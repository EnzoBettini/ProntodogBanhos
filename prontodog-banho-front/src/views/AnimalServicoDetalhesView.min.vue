<template><div class="relative min-h-screen bg-gradient-to-br from-amber-50 via-white to-green-50 p-4 pb-32 overflow-x-hidden"><div class="absolute inset-0 overflow-hidden pointer-events-none z-0"><div class="absolute top-20 left-10 w-72 h-72 bg-amber-200/20 rounded-full blur-3xl"></div><div class="absolute bottom-20 right-10 w-96 h-96 bg-green-200/20 rounded-full blur-3xl"></div><div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl h-96 bg-gradient-to-r from-amber-100/10 to-green-100/10 rounded-full blur-3xl"></div></div><div class="relative z-20 max-w-7xl mx-auto pt-8"><div v-if="loading" class="text-center py-12"><div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-amber-400 to-green-500 rounded-full mb-4 animate-spin"><FontAwesomeIcon :icon="['fas', 'spinner']" class="text-white text-2xl" /></div><p class="text-gray-600 text-lg">Carregando detalhes...</p></div><div v-else-if="error" class="text-center py-12"><div class="inline-flex items-center justify-center w-16 h-16 bg-red-500 rounded-full mb-4"><FontAwesomeIcon :icon="['fas', 'exclamation-triangle']" class="text-white text-2xl" /></div><h3 class="text-xl font-semibold text-gray-800 mb-2">Erro ao carregar</h3><p class="text-gray-600 mb-4">{{ error}}</p><BaseButton @click="carregarDados" variant="primary"><FontAwesomeIcon :icon="['fas', 'refresh']" class="mr-2" />Tentar Novamente </BaseButton></div><div v-else-if="animalServico"><div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 mb-8"><BaseButton @click="voltarParaLista" variant="ghost" class="flex items-center gap-2"><FontAwesomeIcon :icon="['fas', 'arrow-left']" /><span class="hidden sm:inline">Voltar para Lista</span></BaseButton><div class="flex-1 min-w-0"><h1 class="text-2xl sm:text-3xl font-bold text-gray-800 break-words">Detalhes do Serviço</h1><p class="text-gray-600 text-sm sm:text-base break-words">Animal:{{ animal?.nome || 'N/A'}} • Serviço:{{ servico?.nome || 'N/A'}}</p></div><div class="flex flex-wrap items-center gap-2 sm:gap-4 w-full sm:w-auto justify-end"><BaseBadge :variant="isServicoCompleto ? 'success' : 'warning'" size="lg" >{{ isServicoCompleto ? 'Completo' : 'Em Andamento'}} </BaseBadge><BaseBadge :variant="getStatusPagamentoBadgeVariant(animalServico.statusPagamento)" size="lg" class="flex items-center gap-2" ><FontAwesomeIcon :icon="getStatusPagamentoIcon(animalServico.statusPagamento)" />{{ getStatusPagamentoTexto(animalServico.statusPagamento)}} </BaseBadge><BaseButton @click="confirmarExclusaoAnimalServico" variant="danger" class="flex items-center gap-2" title="Excluir este animal serviço" ><FontAwesomeIcon :icon="['fas', 'trash']" /><span class="hidden sm:inline">Excluir</span></BaseButton></div></div><div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 w-full overflow-hidden"><BaseCard class="shadow-xl border-0 w-full min-w-0"><div class="flex items-center gap-3 mb-4"><div class="w-12 h-12 bg-gradient-to-br from-amber-400 to-green-500 rounded-xl flex items-center justify-center"><FontAwesomeIcon :icon="['fas', 'clipboard-list']" class="text-white text-xl" /></div><div><h2 class="text-xl font-bold text-gray-800">Informações Básicas</h2><p class="text-gray-600">Dados essenciais do serviço</p></div></div><div class="space-y-3"><div v-if="isPackageExpired" class="relative overflow-hidden p-4 bg-gradient-to-r from-red-50 to-orange-50 rounded-xl border-2 border-red-200 animate-pulse"><div class="absolute top-0 right-0 w-16 h-16 bg-red-200/30 rounded-full blur-2xl"></div><div class="relative flex items-center gap-3"><div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center animate-bounce"><FontAwesomeIcon :icon="['fas', 'exclamation-triangle']" class="text-white text-sm" /></div><div><p class="text-red-800 font-bold text-sm">⚠️ PACOTE VENCIDO</p><p class="text-red-600 text-sm">Expirou em{{ formatarData(animalServico?.dataExpiracao!)}} <span class="ml-2 text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full">{{ diasVencido}} dia{{ diasVencido !==1 ? 's' : ''}} atrás </span></p></div></div></div><div class="p-4 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200"><div class="flex items-center gap-3"><FontAwesomeIcon :icon="['fas', 'hashtag']" class="text-gray-600" /><div><p class="text-sm font-medium text-gray-600">ID do Registro</p><p class="text-lg font-mono font-bold text-gray-800 tracking-wide break-all">#{{ animalServico?.id}}</p></div></div></div><div class="flex items-center justify-between p-4 bg-gradient-to-r from-amber-50 to-green-50 rounded-xl border border-amber-200"><div class="flex items-center gap-3"><FontAwesomeIcon :icon="['fas', 'calendar-alt']" class="text-amber-600" /><div><p class="text-sm font-medium text-gray-600">Data de Lançamento</p><p class="text-lg font-semibold text-gray-800">{{ formatarData(animalServico?.dataServico)}}</p></div></div><BaseButton @click="editarData=true" variant="ghost" size="sm"><FontAwesomeIcon :icon="['fas', 'edit']" class="mr-1" />Editar </BaseButton></div><div v-if="isServicoUnico" class="p-4 rounded-xl border-2" :class="{ 'bg-gradient-to-r from-green-50 to-emerald-50 border-green-200': getStatusServicoUnico==='realizado', 'bg-gradient-to-r from-gray-50 to-slate-50 border-gray-200': getStatusServicoUnico==='pendente'}" ><div class="flex items-center justify-between mb-3"><div class="flex items-center gap-3"><FontAwesomeIcon :icon="getStatusServicoUnico==='realizado' ? 'check-circle' : 'clock'" :class="{ 'text-green-600': getStatusServicoUnico==='realizado', 'text-gray-600': getStatusServicoUnico==='pendente'}" /><div><p class="text-sm font-medium text-gray-600">Status do Serviço</p><p class="text-lg font-semibold" :class="{ 'text-green-800': getStatusServicoUnico==='realizado', 'text-gray-800': getStatusServicoUnico==='pendente'}" >{{ getStatusServicoUnico==='realizado' ? 'Realizado' : '⏳ Pendente'}} </p></div></div><div v-if="getStatusServicoUnico==='realizado'" class="text-right"><p class="text-sm font-medium text-gray-600">Data de Realização</p><div v-if="!editandoDataRealizacao" class="flex items-center gap-2"><p class="text-sm font-semibold text-gray-800">{{ animalServico?.dataRealizacao ? formatarData(animalServico.dataRealizacao) : ''}} </p><button @click="iniciarEdicaoDataRealizacao" class="p-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-all duration-200" title="Editar data de realização" ><FontAwesomeIcon :icon="['fas', 'edit']" class="text-xs" /></button></div><div v-else class="space-y-2"><input v-model="novaDataRealizacao" type="date" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-200" :max="hoje" /><div class="flex items-center gap-1"><button @click="salvarDataRealizacao" class="px-2 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" ><FontAwesomeIcon :icon="['fas', 'check']" /></button><button @click="cancelarEdicaoDataRealizacao" class="px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 disabled:opacity-50 transition-colors" ><FontAwesomeIcon :icon="['fas', 'times']" /></button></div></div></div></div><div class="flex gap-2"><BaseButton v-if="getStatusServicoUnico==='pendente'" @click="confirmarRealizacaoServico(hoje)" variant="primary" size="sm" class="flex-1 bg-green-600 hover:bg-green-700" ><FontAwesomeIcon :icon="['fas', 'check']" class="mr-2" />Marcar como Realizado </BaseButton><BaseButton v-else @click="marcarComoPendente" variant="primary" size="sm" class="flex-1 bg-gray-600 hover:bg-gray-700" ><FontAwesomeIcon :icon="['fas', 'undo']" class="mr-2" />Marcar como Pendente </BaseButton></div></div><div v-if="!isServicoUnico" class="p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border border-blue-200"><div class="flex items-center gap-3 mb-3"><FontAwesomeIcon :icon="['fas', 'bath']" class="text-blue-600" /><div><p class="text-sm font-medium text-gray-600">Progresso dos Banhos</p><p class="text-lg font-semibold text-gray-800">{{ animalServico?.banhosUsados}} de{{ totalBanhos}} banhos </p></div></div><div class="w-full bg-gray-200 rounded-full h-3 mb-3"><div class="h-3 rounded-full transition-all duration-500" :class="{ 'bg-green-500': progressoBanhos===100, 'bg-yellow-400': progressoBanhos >0 && progressoBanhos < 100, 'bg-red-400': progressoBanhos===0}" :style="{ width: `${progressoBanhos}%`}" ></div></div><BaseButton v-if="podeAdicionarBanho" @click="mostrarModalBanho=true" variant="primary" size="sm" class="w-full" ><FontAwesomeIcon :icon="['fas', 'plus-circle']" class="mr-2" />Registrar Próximo Banho </BaseButton><p v-else class="text-center text-gray-500 text-sm font-medium">✅ Todos os banhos foram realizados </p></div><div class="p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border border-purple-200"><div class="flex items-center gap-3 mb-3"><FontAwesomeIcon :icon="['fas', 'wrench']" class="text-purple-600" /><div><p class="text-sm font-medium text-gray-600">Serviço Contratado</p><p class="text-lg font-semibold text-gray-800">{{ servico?.nome || 'N/A'}}</p></div></div><div class="grid grid-cols-2 gap-4 text-sm mb-3"><div><p class="text-gray-600">Quantidade:</p><p class="font-medium">{{ servico?.quantidade || 'N/A'}} banhos</p></div><div><p class="text-gray-600">Descrição:</p><p class="font-medium">{{ servico?.descricao || 'N/A'}}</p></div></div><div class="pt-3 border-t border-purple-200"><p class="text-gray-600 text-sm">Lançado por:</p><p class="font-medium text-purple-800">{{ usuario?.nome || 'N/A'}}</p></div></div></div></BaseCard><BaseCard class="shadow-xl border-0 w-full min-w-0"><div class="flex items-center gap-3 mb-4"><div class="w-12 h-12 bg-gradient-to-br from-emerald-400 to-blue-500 rounded-xl flex items-center justify-center"><FontAwesomeIcon :icon="['fas', 'check-circle']" class="text-white text-xl" /></div><div><h2 class="text-xl font-bold text-gray-800">Controle & Status</h2><p class="text-gray-600">Pagamento e expiração</p></div></div><div class="space-y-3"><div class="p-4 rounded-xl border" :class="{ 'bg-gradient-to-r from-emerald-50 to-green-50 border-emerald-200': animalServico?.statusPagamento==='pago', 'bg-gradient-to-r from-orange-50 to-yellow-50 border-orange-200': animalServico?.statusPagamento==='em_aberto', 'bg-gradient-to-r from-red-50 to-pink-50 border-red-200': animalServico?.statusPagamento==='cancelado'}"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><FontAwesomeIcon :icon="getStatusPagamentoIcon(animalServico?.statusPagamento)" :class="{ 'text-emerald-600': animalServico?.statusPagamento==='pago', 'text-orange-600': animalServico?.statusPagamento==='em_aberto', 'text-red-600': animalServico?.statusPagamento==='cancelado'}" /><div><p class="text-sm font-medium" :class="{ 'text-emerald-700': animalServico?.statusPagamento==='pago', 'text-orange-700': animalServico?.statusPagamento==='em_aberto', 'text-red-700': animalServico?.statusPagamento==='cancelado'}">Status do Pagamento </p><p class="text-lg font-semibold" :class="{ 'text-emerald-800': animalServico?.statusPagamento==='pago', 'text-orange-800': animalServico?.statusPagamento==='em_aberto', 'text-red-800': animalServico?.statusPagamento==='cancelado'}">{{ getStatusPagamentoTexto(animalServico?.statusPagamento)}} </p></div></div><div v-if="animalServico?.dataPagamento" class="text-right"><div class="flex items-center gap-2"><div><p class="text-xs font-medium text-gray-600">Data do Pagamento</p><div v-if="!editandoDataPagamento" class="flex items-center gap-2"><p class="text-sm font-semibold text-gray-800">{{ formatarData(animalServico?.dataPagamento)}} </p><button @click="iniciarEdicaoDataPagamento" class="p-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-all duration-200" title="Editar data de pagamento" ><FontAwesomeIcon :icon="['fas', 'edit']" class="text-xs" /></button></div><div v-else class="space-y-2"><input v-model="novaDataPagamento" type="date" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-200" :disabled="salvandoDataPagamento" /><div class="flex items-center gap-1"><button @click="salvarDataPagamento" :disabled="salvandoDataPagamento || !novaDataPagamento" class="px-2 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" ><FontAwesomeIcon v-if="salvandoDataPagamento" :icon="['fas', 'spinner']" class="animate-spin" /><FontAwesomeIcon v-else :icon="['fas', 'check']" /></button><button @click="cancelarEdicaoDataPagamento" :disabled="salvandoDataPagamento" class="px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 disabled:opacity-50 transition-colors" ><FontAwesomeIcon :icon="['fas', 'times']" /></button></div></div></div></div></div><div v-else-if="animalServico?.statusPagamento==='pago'" class="text-right"><div v-if="!editandoDataPagamento" class="flex items-center gap-2"><div><p class="text-xs font-medium text-gray-600">Data do Pagamento</p><p class="text-sm text-gray-500 italic">Não definida</p></div><button @click="iniciarDefinicaoDataPagamento" class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors" title="Definir data de pagamento" ><FontAwesomeIcon :icon="['fas', 'calendar-plus']" class="mr-1" />Definir </button></div><div v-else class="space-y-2"><p class="text-xs font-medium text-gray-600">Definir Data do Pagamento</p><input v-model="novaDataPagamento" type="date" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-200" :disabled="salvandoDataPagamento" placeholder="Selecione a data" /><div class="flex items-center gap-1"><button @click="salvarDataPagamento" :disabled="salvandoDataPagamento || !novaDataPagamento" class="px-2 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" ><FontAwesomeIcon v-if="salvandoDataPagamento" :icon="['fas', 'spinner']" class="animate-spin" /><FontAwesomeIcon v-else :icon="['fas', 'check']" /></button><button @click="cancelarEdicaoDataPagamento" :disabled="salvandoDataPagamento" class="px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 disabled:opacity-50 transition-colors" ><FontAwesomeIcon :icon="['fas', 'times']" /></button></div></div></div></div></div><div v-if="animalServico?.vendaId" class="p-5 rounded-xl border-2 bg-gradient-to-br from-indigo-50 via-purple-50 to-indigo-50 border-indigo-300 shadow-md hover:shadow-lg transition-all duration-300"><div class="flex flex-col gap-4"><div class="flex items-start justify-between gap-4"><div class="flex items-start gap-3 flex-1"><div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center flex-shrink-0 shadow-md"><FontAwesomeIcon :icon="['fas', 'receipt']" class="text-white text-lg" /></div><div class="flex-1 min-w-0"><p class="text-xs font-medium text-indigo-600 uppercase tracking-wide mb-1">Venda Relacionada</p><p class="text-2xl font-bold text-indigo-900 mb-1">Venda #{{ animalServico?.vendaId}}</p><p class="text-sm text-indigo-700">Este serviço faz parte de uma venda</p></div></div><router-link :to="`/vendas/${animalServico?.vendaId}`" class="px-5 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-xl font-semibold transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-105 flex items-center gap-2.5 whitespace-nowrap flex-shrink-0" title="Ver detalhes completos da venda" ><FontAwesomeIcon :icon="['fas', 'arrow-right']" class="text-sm" /><span>Ver Venda</span><FontAwesomeIcon :icon="['fas', 'external-link-alt']" class="text-xs" /></router-link></div></div></div><div v-if="animalServico?.dataExpiracao" class="p-4 bg-gradient-to-r from-violet-50 to-purple-50 rounded-xl border border-violet-200" :class="{ 'border-red-300 bg-gradient-to-r from-red-50 to-orange-50': isPackageExpired, 'border-yellow-300 bg-gradient-to-r from-yellow-50 to-amber-50': isPackageExpiringSoon && !isPackageExpired, 'border-green-300 bg-gradient-to-r from-green-50 to-emerald-50': !isPackageExpired && !isPackageExpiringSoon}"><div class="flex items-center gap-3"><FontAwesomeIcon :icon="['fas', 'clock']" :class="{ 'text-red-600': isPackageExpired, 'text-yellow-600': isPackageExpiringSoon && !isPackageExpired, 'text-violet-600': !isPackageExpired && !isPackageExpiringSoon}" /><div class="flex-1"><p class="text-sm font-medium" :class="{ 'text-red-700': isPackageExpired, 'text-yellow-700': isPackageExpiringSoon && !isPackageExpired, 'text-gray-600': !isPackageExpired && !isPackageExpiringSoon}">Data de Expiração </p><p class="text-lg font-semibold" :class="{ 'text-red-800': isPackageExpired, 'text-yellow-800': isPackageExpiringSoon && !isPackageExpired, 'text-gray-800': !isPackageExpired && !isPackageExpiringSoon}">{{ formatarData(animalServico?.dataExpiracao)}} </p></div><div v-if="!isPackageExpired" class="text-right"><p class="text-xs font-medium" :class="{ 'text-yellow-700': isPackageExpiringSoon, 'text-green-700': !isPackageExpiringSoon}">{{ isPackageExpiringSoon ? 'Expira em' : 'Válido por mais'}} </p><p class="text-sm font-bold" :class="{ 'text-yellow-800': isPackageExpiringSoon, 'text-green-800': !isPackageExpiringSoon}">{{ diasParaExpirar}} dia{{ diasParaExpirar !==1 ? 's' : ''}} </p></div></div></div><div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200"><div class="flex items-center gap-3 mb-3"><FontAwesomeIcon :icon="['fas', 'file-pdf']" class="text-blue-600" /><div class="flex-1"><p class="text-sm font-medium text-blue-700">Relatório do Serviço</p><p class="text-xs text-blue-600">Gere um PDF completo com todos os detalhes</p></div></div><BaseButton @click="gerarRelatorioPDF" :disabled="gerandoPDF" variant="primary" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700" ><FontAwesomeIcon :icon="gerandoPDF ? ['fas', 'spinner'] : ['fas', 'file-pdf']" :class="{ 'animate-spin': gerandoPDF}" class="mr-2" />{{ gerandoPDF ? 'Gerando PDF...' : 'Gerar Relatório PDF'}} </BaseButton></div></div></BaseCard><BaseCard class="shadow-xl border-0 w-full lg:col-span-2 xl:col-span-1 min-w-0"><div class="flex items-center gap-3 mb-4"><div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-purple-500 rounded-xl flex items-center justify-center"><FontAwesomeIcon :icon="['fas', 'paw']" class="text-white text-xl" /></div><div><h2 class="text-xl font-bold text-gray-800">Informações do Animal</h2><p class="text-gray-600">Dados do pet atendido</p></div></div><div v-if="animal" class="space-y-4"><div class="flex items-center gap-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border border-blue-200"><div class="w-16 h-16 bg-gradient-to-br from-blue-400 to-purple-500 rounded-xl flex items-center justify-center text-white text-2xl"><FontAwesomeIcon :icon="getAnimalFontAwesomeIcon(animal.tipo)" /></div><div class="flex-1"><h3 class="text-xl font-bold text-gray-800">{{ animal.nome}}</h3><p class="text-gray-600">{{ animal.tipo}}</p><p class="text-sm text-gray-500">Código:{{ animal.codigoSimplesVet}}</p></div><BaseButton @click="verDetalhesAnimal" variant="ghost" size="sm"><FontAwesomeIcon :icon="['fas', 'external-link-alt']" class="mr-1" />Ver Detalhes </BaseButton></div><div class="p-4 bg-gradient-to-r from-emerald-50 to-teal-50 rounded-xl border border-emerald-200"><div class="flex items-center gap-3 mb-3"><FontAwesomeIcon :icon="['fas', 'user']" class="text-emerald-600" /><div class="flex-1"><p class="text-sm font-medium text-gray-600">Cliente Responsável</p><p class="text-lg font-semibold text-gray-800">{{ cliente?.nomeCompleto || 'N/A'}}</p></div><BaseButton v-if="cliente" @click="verDetalhesCliente" variant="ghost" size="sm"><FontAwesomeIcon :icon="['fas', 'external-link-alt']" class="mr-1" />Ver Cliente </BaseButton></div><div v-if="cliente" class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm"><div><p class="text-gray-600">CPF:</p><p class="font-medium">{{ formatarCpf(cliente.cpf)}}</p></div><div v-if="cliente.telefones && cliente.telefones.length >0"><p class="text-gray-600">Telefone:</p><p class="font-medium">{{ cliente.telefones?.[0]?.telefone ? formatarTelefone(cliente.telefones[0].telefone) : 'N/A'}}</p></div><div v-if="cliente.emailClientes && cliente.emailClientes.length >0" class="sm:col-span-2"><p class="text-gray-600">Email:</p><p class="font-medium">{{ cliente.emailClientes?.[0]?.email || 'N/A'}}</p></div></div><p v-else class="text-gray-500 text-sm">Cliente não encontrado</p></div></div><div v-else class="text-center py-8"><FontAwesomeIcon :icon="['fas', 'exclamation-circle']" class="text-gray-400 text-3xl mb-2" /><p class="text-gray-500">Animal não encontrado</p></div></BaseCard></div><div class="mt-6 w-full min-w-0"><BaseCard class="shadow-xl border-0"><div class="flex items-center gap-3 mb-4"><div class="w-12 h-12 bg-gradient-to-br from-green-400 to-emerald-500 rounded-xl flex items-center justify-center"><FontAwesomeIcon :icon="['fas', 'dollar-sign']" class="text-white text-xl" /></div><div class="flex-1"><h2 class="text-xl font-bold text-gray-800">Resumo Financeiro</h2><p class="text-gray-600">{{ temServicosAdicionais ? `${1 + servicosAdicionais.length} serviços contratados` : '1 serviço contratado'}} • Total: R${{ valorTotalGeral.toFixed(2).replace('.', ',')}} </p></div><div class="flex items-center gap-2"><BaseButton @click="abrirModalEditarServico" variant="secondary" size="sm"><FontAwesomeIcon :icon="['fas', 'edit']" class="mr-1" />Editar Serviço </BaseButton><BaseButton @click="adicionarNovoServicoAdicional" variant="primary" size="sm"><FontAwesomeIcon :icon="['fas', 'plus']" class="mr-1" />Adicionar Extra </BaseButton></div></div><div class="space-y-3"><div class="flex items-center justify-between p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border border-indigo-200"><div class="flex items-center gap-4"><div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white text-sm font-bold"><FontAwesomeIcon :icon="['fas', 'star']" /></div><div><h3 class="font-bold text-gray-800">{{ servico?.nome || 'N/A'}}</h3><p class="text-sm text-gray-600">Serviço Principal •{{ servico?.quantidade || 'N/A'}} banhos </p><p class="text-xs text-gray-500">Lançado por:{{ usuario?.nome || 'N/A'}} </p></div></div><div class="text-right"><p class="text-2xl font-bold text-indigo-600">R${{ (animalServico?.valorTotalServico || servico?.valor || 0).toFixed(2).replace('.', ',')}} </p><p class="text-sm text-gray-500">Serviço Principal</p><p v-if="animalServico?.valorCobrado && servico?.valor !==animalServico?.valorCobrado" class="text-xs text-gray-500 line-through">Valor catálogo: R${{ (servico?.valor || 0).toFixed(2).replace('.', ',')}} </p></div></div><div v-if="temServicosAdicionais"><div class="flex items-center gap-2 mb-3 mt-4"><FontAwesomeIcon :icon="['fas', 'plus-circle']" class="text-amber-500" /><h3 class="font-semibold text-gray-800">Serviços Adicionais</h3><span class="text-sm text-gray-500">({{ servicosAdicionais.length}} item{{ servicosAdicionais.length !==1 ? 's' : ''}})</span></div><div v-for="adicional in servicosAdicionais" :key="adicional.id" class="flex items-center justify-between p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-200 mb-3" ><div class="flex items-center gap-4"><div class="w-10 h-10 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center text-white text-lg font-bold">+ </div><div><h3 class="font-bold text-gray-800">{{ adicional.nomeServicoAdicional}}</h3><div class="flex items-center gap-3 text-sm text-gray-600"><span>Quantidade:{{ adicional.quantidade}}</span><span>•</span><span>R${{ adicional.valorUnitario.toFixed(2).replace('.', ',')}} cada</span><template v-if="adicional.dataRealizacao"><span>•</span><span class="flex items-center gap-1"><FontAwesomeIcon :icon="['fas', 'calendar-check']" class="text-green-500 text-xs" />{{ formatarData(adicional.dataRealizacao)}} </span></template><template v-if="adicional.statusPagamento !=='em_aberto'"><span>•</span><BaseBadge :variant="getStatusPagamentoBadgeVariant(adicional.statusPagamento)" size="sm" >{{ getStatusPagamentoTexto(adicional.statusPagamento)}} </BaseBadge></template></div><p v-if="adicional.observacoes" class="text-xs text-gray-500 mt-1">{{ adicional.observacoes}} </p></div></div><div class="flex items-center gap-3"><div class="text-right"><p class="text-2xl font-bold text-amber-600">R${{ adicional.valorTotal.toFixed(2).replace('.', ',')}} </p><p class="text-sm text-gray-500">Serviço Adicional</p></div><div class="flex flex-col gap-1"><BaseButton @click="editarServicoAdicional(adicional)" variant="ghost" size="sm" class="text-amber-600 hover:text-amber-700 p-1" ><FontAwesomeIcon :icon="['fas', 'edit']" class="text-xs" /></BaseButton><BaseButton @click="removerServicoAdicional(adicional)" variant="ghost" size="sm" class="text-red-600 hover:text-red-700 p-1" ><FontAwesomeIcon :icon="['fas', 'trash']" class="text-xs" /></BaseButton></div></div></div></div><div class="mt-4 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border-2 border-green-200"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center text-white"><FontAwesomeIcon :icon="['fas', 'calculator']" /></div><div><h3 class="font-bold text-gray-800">Valor Total Geral</h3><p class="text-sm text-gray-600">{{ temServicosAdicionais ? `Principal: R$ ${valorTotalPrincipal.toFixed(2).replace('.', ',')} + Adicionais: R$ ${valorTotalAdicionais.toFixed(2).replace('.', ',')}` : 'Apenas serviço principal'}} </p></div></div><div class="text-right"><p class="text-3xl font-bold text-green-600">R${{ valorTotalGeral.toFixed(2).replace('.', ',')}} </p><p class="text-sm text-gray-500">Total a Pagar</p></div></div></div></div><div v-if="!temServicosAdicionais" class="mt-4 text-center py-4 bg-gray-50 rounded-xl"><FontAwesomeIcon :icon="['fas', 'info-circle']" class="text-gray-400 text-2xl mb-2" /><p class="text-gray-500 text-sm">Apenas o serviço principal foi contratado</p></div></BaseCard></div><div v-if="!isServicoUnico && servico && servico.quantidade >1" class="mt-6 w-full min-w-0"><BaseCard class="shadow-xl border-0"><div class="flex items-center gap-3 mb-4"><div class="w-12 h-12 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-xl flex items-center justify-center"><FontAwesomeIcon :icon="['fas', 'history']" class="text-white text-xl" /></div><div><h2 class="text-xl font-bold text-gray-800">Histórico de Banhos</h2><p class="text-gray-600">Registro de banhos individuais do pacote</p></div></div><div v-if="banhosIndividuais.length" class="space-y-3"><div v-for="banho in banhosIndividuais" :key="banho.id" class="flex items-center justify-between p-4 bg-gradient-to-r from-cyan-50 to-blue-50 rounded-xl border border-cyan-200" ><div class="flex items-center gap-3"><div class="w-8 h-8 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">{{ banho.numeroBanho}} </div><div><p class="font-semibold text-gray-800">{{ formatarData(banho.dataBanho)}}</p><p v-if="banho.observacoes" class="text-sm text-gray-600">{{ banho.observacoes}}</p><p v-else class="text-sm text-gray-500 italic">Sem observações</p></div></div><BaseButton @click="excluirBanho(banho)" variant="ghost" size="sm" class="text-red-600 hover:text-red-700"><FontAwesomeIcon :icon="['fas', 'trash']" /></BaseButton></div></div><div v-else class="text-center py-8"><FontAwesomeIcon :icon="['fas', 'bath']" class="text-gray-400 text-3xl mb-2" /><p class="text-gray-500">Nenhum banho individual registrado ainda</p></div></BaseCard></div></div><div v-else class="text-center py-12"><div class="inline-flex items-center justify-center w-16 h-16 bg-gray-500 rounded-full mb-4"><FontAwesomeIcon :icon="['fas', 'search']" class="text-white text-2xl" /></div><h3 class="text-xl font-semibold text-gray-800 mb-2">Serviço não encontrado</h3><p class="text-gray-600 mb-4">O registro solicitado não existe ou foi removido.</p><BaseButton @click="voltarParaLista" variant="primary"><FontAwesomeIcon :icon="['fas', 'arrow-left']" class="mr-2" />Voltar para Lista </BaseButton></div></div><BaseModal v-model="editarData" title="Editar Data do Serviço" size="md"><div class="space-y-6"><div><label class="block text-sm font-medium text-gray-700 mb-2">Nova Data</label><input type="date" v-model="novaData" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" /></div><div class="flex gap-3 pt-4 border-t"><BaseButton @click="editarData=false" variant="ghost" class="flex-1">Cancelar </BaseButton><BaseButton @click="salvarNovaData" variant="primary" class="flex-1" :disabled="salvandoData"><FontAwesomeIcon :icon="['fas', 'spinner']" v-if="salvandoData" class="mr-2 animate-spin" /><FontAwesomeIcon :icon="['fas', 'save']" v-else class="mr-2" />{{ salvandoData ? 'Salvando...' : 'Salvar'}} </BaseButton></div></div></BaseModal><BaseModal v-model="mostrarModalBanho" title="Registrar Banho Individual" size="md"><div class="space-y-6"><p class="text-gray-700 text-lg font-semibold">Registrando banho para: <span class="text-green-600">{{ animal?.nome}}</span></p><p class="text-gray-600 text-md">Próximo banho: <span class="font-bold text-lg text-blue-600">{{ (animalServico?.banhosUsados || 0) + 1}}</span></p><div class="space-y-4"><div><label class="block text-sm font-semibold text-gray-700 mb-2"><FontAwesomeIcon :icon="['fas', 'calendar-alt']" class="mr-2 text-blue-600" />Data do Serviço* </label><input type="date" v-model="formularioBanho.dataBanho" required class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300 hover:border-gray-300" /></div><div><label class="block text-sm font-semibold text-gray-700 mb-2"><FontAwesomeIcon :icon="['fas', 'align-left']" class="mr-2 text-green-600" />Observações </label><textarea v-model="formularioBanho.observacoes" placeholder="Observações sobre este banho (opcional)..." rows="3" class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-green-500 focus:ring-4 focus:ring-green-100 transition-all duration-300 resize-none hover:border-gray-300" ></textarea></div></div><div class="flex flex-col sm:flex-row gap-3 pt-4 border-t"><BaseButton @click="mostrarModalBanho=false" variant="ghost" class="w-full sm:w-auto">Cancelar </BaseButton><BaseButton @click="salvarBanhoIndividual" variant="primary" :disabled="!formularioBanho.dataBanho || salvandoBanho" class="w-full sm:w-auto" ><FontAwesomeIcon v-if="salvandoBanho" :icon="['fas', 'spinner']" class="mr-2 animate-spin" /><FontAwesomeIcon v-else :icon="['fas', 'bath']" class="mr-2" />Registrar Banho </BaseButton></div></div></BaseModal><BaseModal v-model="mostrarModalAdicionarExtra" title="Adicionar Serviço Extra"><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-2"><FontAwesomeIcon :icon="['fas', 'search']" class="text-blue-600 mr-2" />Serviço Adicional * </label><SearchSelect v-model="formularioServicoAdicional.servicoId" :options="servicosAdicionaisDisponiveis" label-key="nome" value-key="id" description-key="servicoDescription" placeholder="🔍 Buscar serviço adicional..." @update:model-value="atualizarValorServicoSelecionado" /></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Quantidade * </label><input v-model.number="formularioServicoAdicional.quantidade" type="number" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required /></div><div v-if="formularioServicoAdicional.valorOriginal >0"><label class="block text-sm font-medium text-gray-700 mb-2">Valor Padrão do Serviço </label><div class="px-3 py-2 bg-gray-100 rounded-lg text-gray-700 font-medium">R${{ formularioServicoAdicional.valorOriginal.toFixed(2).replace('.', ',')}} </div></div><div v-if="formularioServicoAdicional.valorOriginal >0" class="flex items-center gap-2"><input v-model="formularioServicoAdicional.alterarValor" type="checkbox" id="alterarValorModal" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" @change="toggleAlterarValorModal" /><label for="alterarValorModal" class="text-sm text-gray-700">Alterar valor para este atendimento específico </label></div><div v-if="formularioServicoAdicional.alterarValor"><label class="block text-sm font-medium text-gray-700 mb-2">Valor Personalizado * </label><input v-model.number="formularioServicoAdicional.valorUnitario" type="number" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required /></div><div class="p-3 bg-blue-50 border border-blue-200 rounded-lg"><div class="flex items-start gap-2"><FontAwesomeIcon :icon="['fas', 'info-circle']" class="text-blue-600 mt-0.5 flex-shrink-0" /><div class="text-sm text-blue-800"><p class="font-medium">Status e Data de Pagamento</p><p>Serão automaticamente herdados do serviço principal ({{ getStatusPagamentoTexto(animalServico?.statusPagamento || 'em_aberto')}}).</p></div></div></div><div><label class="block text-sm font-medium text-gray-700 mb-2"><FontAwesomeIcon :icon="['fas', 'calendar-check']" class="text-green-600 mr-2" />Data de Realização * </label><input v-model="formularioServicoAdicional.dataRealizacao" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required /><p class="text-xs text-gray-500 mt-1">Por padrão, usa a mesma data do serviço principal, mas você pode alterá-la. </p></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Observações </label><textarea v-model="formularioServicoAdicional.observacoes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Observações sobre este serviço adicional..." ></textarea></div><div class="flex justify-end gap-3 pt-4"><BaseButton @click="mostrarModalAdicionarExtra=false" variant="ghost">Cancelar </BaseButton><BaseButton @click="salvarServicoAdicional" variant="primary" :disabled="editandoServicos || !formularioServicoAdicional.servicoId" ><FontAwesomeIcon v-if="editandoServicos" :icon="['fas', 'spinner']" class="animate-spin mr-2" />{{ editandoServicos ? 'Salvando...' : 'Adicionar Serviço'}} </BaseButton></div></div></BaseModal><BaseModal v-model="mostrarModalEditarAdicional" title="Editar Serviço Adicional"><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Serviço </label><div class="px-3 py-2 bg-gray-100 rounded-lg text-gray-700 font-medium">{{ formularioServicoAdicional.servicoNome}} </div></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Quantidade * </label><input v-model.number="formularioServicoAdicional.quantidade" type="number" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required /></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Valor Unitário * </label><input v-model.number="formularioServicoAdicional.valorUnitario" type="number" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required /></div><div class="p-3 bg-blue-50 border border-blue-200 rounded-lg"><div class="flex items-start gap-2"><FontAwesomeIcon :icon="['fas', 'info-circle']" class="text-blue-600 mt-0.5 flex-shrink-0" /><div class="text-sm text-blue-800"><p class="font-medium">Status e Data de Pagamento</p><p>Sempre herdam automaticamente do serviço principal ({{ getStatusPagamentoTexto(animalServico?.statusPagamento || 'em_aberto')}}).</p></div></div></div><div><label class="block text-sm font-medium text-gray-700 mb-2"><FontAwesomeIcon :icon="['fas', 'calendar-check']" class="text-green-600 mr-2" />Data de Realização * </label><input v-model="formularioServicoAdicional.dataRealizacao" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required /><p class="text-xs text-gray-500 mt-1">Você pode alterar a data de realização conforme necessário. </p></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Observações </label><textarea v-model="formularioServicoAdicional.observacoes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Observações sobre este serviço adicional..." ></textarea></div><div class="flex justify-end gap-3 pt-4"><BaseButton @click="mostrarModalEditarAdicional=false" variant="ghost">Cancelar </BaseButton><BaseButton @click="salvarServicoAdicional" variant="primary" :disabled="editandoServicos" ><FontAwesomeIcon v-if="editandoServicos" :icon="['fas', 'spinner']" class="animate-spin mr-2" />{{ editandoServicos ? 'Salvando...' : 'Salvar Alterações'}} </BaseButton></div></div></BaseModal><div class="fixed bottom-0 left-0 right-0 w-full overflow-hidden z-10 pointer-events-none"><svg viewBox="0 0 1440 120" class="w-full h-20 md:h-24" preserveAspectRatio="none"><defs><linearGradient id="detalhesWave" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#F59E0B;stop-opacity:0.9" /><stop offset="50%" style="stop-color:#10B981;stop-opacity:0.8" /><stop offset="100%" style="stop-color:#047857;stop-opacity:1" /></linearGradient></defs><path d="M0,60 C120,45 240,30 360,45 C480,60 600,75 720,60 C840,45 960,30 1080,45 C1200,60 1320,75 1440,60 L1440,120 L0,120 Z" fill="url(#detalhesWave)" /></svg></div></div><BaseModal v-model="mostrarModalEditarServico" title="Editar Serviço Principal" ><div class="space-y-6"><div><label class="block text-sm font-medium text-gray-700 mb-2"><FontAwesomeIcon :icon="['fas', 'search']" class="text-blue-600 mr-2" />Serviço * </label><SearchSelect v-model="formularioEditarServico.servicoId" :options="todosServicos" label-key="nome" value-key="id" description-key="servicoDescription" placeholder="🔍 Buscar serviço..." @update:model-value="(value)=>console.log('🔄 Serviço selecionado:', value)" /></div><div><label class="block text-sm font-medium text-gray-700 mb-2"><FontAwesomeIcon :icon="['fas', 'user']" class="text-purple-600 mr-2" />Quem lançou o serviço * </label><SearchSelect v-model="formularioEditarServico.usuarioId" :options="todosUsuarios" label-key="nome" value-key="id" description-key="usuarioDescription" placeholder="🔍 Buscar usuário..." @update:model-value="(value)=>console.log('👤 Usuário selecionado:', value)" /></div><div><label class="block text-sm font-medium text-gray-700 mb-2"><FontAwesomeIcon :icon="['fas', 'calendar']" class="text-green-600 mr-2" />Data do Serviço* </label><input v-model="formularioEditarServico.dataServico" type="date" required class="w-full px-4 py-3 bg-white border-2 border-green-200 rounded-xl focus:border-green-500 focus:ring-4 focus:ring-green-100 transition-all duration-300 text-base font-medium hover:border-green-300" /></div><div><label class="block text-sm font-medium text-gray-700 mb-2"><FontAwesomeIcon :icon="['fas', 'clock']" class="text-orange-600 mr-2" />Data de Expiração (opcional) </label><input v-model="formularioEditarServico.dataExpiracao" type="date" class="w-full px-4 py-3 bg-white border-2 border-orange-200 rounded-xl focus:border-orange-500 focus:ring-4 focus:ring-orange-100 transition-all duration-300 text-base font-medium hover:border-orange-300" /></div><div><label class="block text-sm font-medium text-gray-700 mb-2"><FontAwesomeIcon :icon="['fas', 'credit-card']" class="text-pink-600 mr-2" />Status do Pagamento * </label><select v-model="formularioEditarServico.statusPagamento" required class="w-full px-4 py-3 pr-12 border-2 border-pink-200 rounded-xl focus:border-pink-500 focus:ring-4 focus:ring-pink-100 transition-all duration-300 bg-white appearance-none cursor-pointer hover:border-pink-300" ><option value="em_aberto">💳 Em Aberto</option><option value="pago">✅ Pago</option><option value="cancelado">❌ Cancelado</option></select></div><div v-if="formularioEditarServico.statusPagamento==='pago'"><label class="block text-sm font-medium text-gray-700 mb-2"><FontAwesomeIcon :icon="['fas', 'calendar-check']" class="text-teal-600 mr-2" />Data do Pagamento * </label><input v-model="formularioEditarServico.dataPagamento" type="date" required class="w-full px-4 py-3 bg-white border-2 border-teal-200 rounded-xl focus:border-teal-500 focus:ring-4 focus:ring-teal-100 transition-all duration-300 text-base font-medium hover:border-teal-300" /></div></div><template #footer><div class="flex items-center justify-end gap-3 pt-6 border-t border-gray-200"><BaseButton @click="mostrarModalEditarServico=false" variant="secondary" :disabled="editandoServicos" >Cancelar </BaseButton><BaseButton @click="salvarEdicaoServico" variant="primary" :disabled="editandoServicos" ><FontAwesomeIcon :icon="editandoServicos ? ['fas', 'spinner'] : ['fas', 'save']" :class="{ 'animate-spin': editandoServicos}" class="mr-2" />{{ editandoServicos ? 'Salvando...' : 'Salvar Alterações'}} </BaseButton></div></template></BaseModal></template><script setup lang="ts">import{ ref, computed, onMounted, type Ref} from 'vue'import{ useRouter} from 'vue-router'import{ FontAwesomeIcon} from '@fortawesome/vue-fontawesome'import BaseCard from '@/components/UI/BaseCard.vue'import BaseButton from '@/components/UI/BaseButton.vue'import BaseModal from '@/components/UI/BaseModal.vue'import BaseBadge from '@/components/UI/BaseBadge.vue'import SearchSelect from '@/components/UI/SearchSelect.vue'import{ animalServicoService, animaisService, servicosService, clientesService, usuariosService, banhosIndividuaisService, servicosAdicionaisService, type NovoBanhoIndividual, type BanhoIndividual} from '@/services/api'import type{ AnimalServico, Animal, ServicoCompleto, Cliente, Usuario} from '@/types/api'import{ formatarCpf, formatarTelefone, getIconeTipoAnimal} from '@/utils/formatters'// Propsinterface Props{ id: string}const props=defineProps<Props>()// Routerconst router=useRouter()// Estadosconst loading=ref(true)const error=ref('')const animalServico=ref<AnimalServico | null>(null)const animal=ref<Animal | null>(null)const servico=ref<ServicoCompleto | null>(null)const cliente=ref<Cliente | null>(null)const usuario=ref<Usuario | null>(null)const banhosIndividuais=ref<BanhoIndividual[]>([])const servicosAdicionais=ref<any[]>([])const valorTotalAdicionais=ref(0)// Estados de ediçãoconst editarData=ref(false)const novaData=ref('')const salvandoData=ref(false)const editandoDataRealizacao=ref(false)const novaDataRealizacao=ref('')const hoje=ref(new Date().toISOString().split('T')[0])// Estados de pagamentoconst mostrarMenuPagamento=ref(false)const alterandoPagamento=ref(false)// Estados de edição de data de pagamentoconst editandoDataPagamento=ref(false)const novaDataPagamento=ref('')const salvandoDataPagamento=ref(false)// Modal de banhoconst mostrarModalBanho=ref(false)const salvandoBanho=ref(false)const formularioBanho=ref({ dataBanho: '', observacoes: ''})// Estados do relatório PDFconst gerandoPDF=ref(false)// Estados para edição de serviçosconst mostrarModalEditarServico=ref(false)const mostrarModalAdicionarExtra=ref(false)const mostrarModalEditarAdicional=ref(false)const editandoServicos=ref(false)const servicoAdicionalEditando=ref<any>(null)// Lista de todos os serviços disponíveis para seleçãoconst todosServicos=ref<ServicoCompleto[]>([])const servicosAdicionaisDisponiveis=ref<ServicoCompleto[]>([])// Formulário para editar serviço principalconst formularioEditarServico=ref({ servicoId: null as number | null, usuarioId: null as number | null, dataServico: '', dataExpiracao: '', statusPagamento: 'em_aberto', dataPagamento: ''})// Lista de usuários para seleçãoconst todosUsuarios=ref<Usuario[]>([])// Formulário para adicionar/editar serviço adicionalconst formularioServicoAdicional=ref({ id: null as number | null, servicoId: null as number | null, // ✅ Alterado para aceitar null servicoNome: '', quantidade: 1, valorUnitario: 0, valorOriginal: 0, observacoes: '', alterarValor: false, dataRealizacao: ''})// Computadasconst totalBanhos=computed(()=>servico.value?.quantidade || 1)const progressoBanhos=computed(()=>{ if (!animalServico.value) return 0 return Math.min((animalServico.value.banhosUsados / totalBanhos.value) * 100, 100)})const isServicoCompleto=computed(()=>{ if (!animalServico.value) return false return animalServico.value.banhosUsados >=totalBanhos.value})const podeAdicionarBanho=computed(()=>{ // Pode adicionar banho se o serviço não está completo (independente da quantidade) return !isServicoCompleto.value && servico.value})// Computadas para valores dos serviçosconst valorTotalPrincipal=computed(()=>{ const valor=animalServico.value?.valorTotalServico || servico.value?.valor || 0 console.log('💰 valorTotalPrincipal:',{ animalServicoId: animalServico.value?.id, valorTotalServico: animalServico.value?.valorTotalServico, valorCobrado: animalServico.value?.valorCobrado, servicoValor: servico.value?.valor, valorFinal: valor}) return valor})const valorTotalGeral=computed(()=>{ return valorTotalPrincipal.value + valorTotalAdicionais.value})const temServicosAdicionais=computed(()=>{ return servicosAdicionais.value.length >0})// 🎯 Funções utilitárias para detectar tipo de serviçoconst isServicoUnico=computed(()=>{ return servico.value?.podeSerAdicional===true})const getStatusServicoUnico=computed(()=>{ if (!animalServico.value) return 'pendente' return animalServico.value.statusServico || 'pendente'})// Computadas para controle de expiraçãoconst isPackageExpired=computed(()=>{ if (!animalServico.value?.dataExpiracao) return false const hoje=new Date() const [ano, mes, dia]=animalServico.value.dataExpiracao.split('-') const dataExpiracao=new Date(Number(ano), Number(mes) - 1, Number(dia)) return hoje >dataExpiracao})const isPackageExpiringSoon=computed(()=>{ if (!animalServico.value?.dataExpiracao || isPackageExpired.value) return false const hoje=new Date() const [ano, mes, dia]=animalServico.value.dataExpiracao.split('-') const dataExpiracao=new Date(Number(ano), Number(mes) - 1, Number(dia)) const diasParaExpirar=Math.ceil((dataExpiracao.getTime() - hoje.getTime()) / (1000 * 60 * 60 * 24)) return diasParaExpirar <=7 // Considera "expirando em breve" se for em 7 dias ou menos})const diasParaExpirar=computed(()=>{ if (!animalServico.value?.dataExpiracao) return 0 const hoje=new Date() const [ano, mes, dia]=animalServico.value.dataExpiracao.split('-') const dataExpiracao=new Date(Number(ano), Number(mes) - 1, Number(dia)) return Math.ceil((dataExpiracao.getTime() - hoje.getTime()) / (1000 * 60 * 60 * 24))})const diasVencido=computed(()=>{ if (!animalServico.value?.dataExpiracao || !isPackageExpired.value) return 0 const hoje=new Date() const [ano, mes, dia]=animalServico.value.dataExpiracao.split('-') const dataExpiracao=new Date(Number(ano), Number(mes) - 1, Number(dia)) return Math.abs(Math.ceil((hoje.getTime() - dataExpiracao.getTime()) / (1000 * 60 * 60 * 24)))})// Funções de exibição de dadosconst formatarData=(data: string | null): string=>{ if (!data) return '-' // Mantém a data exatamente como está, apenas formata para pt-BR const [ano, mes, dia]=data.split('-') return `${dia}/${mes}/${ano}`}// Funções de edição da data de realização e statusconst getAnimalIcon=(tipo: string)=>{ return getIconeTipoAnimal(tipo)}const getAnimalFontAwesomeIcon=(tipo: string): string[]=>{ const icones: Record<string, string[]>={ 'Cachorro': ['fas', 'dog'], 'Gato': ['fas', 'paw'], 'Pássaro': ['fas', 'paw'], 'Coelho': ['fas', 'paw'], 'Hamster': ['fas', 'paw'], 'Peixe': ['fas', 'paw'], 'Tartaruga': ['fas', 'paw']} return icones[tipo] || ['fas', 'paw']}// 💳 Funções para status de pagamentoconst getStatusPagamentoIcon=(status: string): string=>{ switch (status){ case 'pago': return 'check-circle' case 'em_aberto': return 'clock' case 'cancelado': return 'times-circle' default: return 'question-circle'}}const getStatusPagamentoTexto=(status: string): string=>{ switch (status){ case 'pago': return 'Pago' case 'parcial': return 'Pagamento Parcial' case 'em_aberto': return 'Em Aberto' case 'cancelado': return 'Cancelado' default: return 'Indefinido'}}const getStatusPagamentoBadgeVariant=(status: string): 'success' | 'warning' | 'danger' | 'secondary'=>{ switch (status){ case 'pago': return 'success' case 'parcial': return 'warning' case 'em_aberto': return 'warning' case 'cancelado': return 'danger' default: return 'secondary'}}// 🔄 Função para sincronizar serviços adicionais com o paiconst sincronizarServicosAdicionaisComPai=async (novoStatus: 'pago' | 'em_aberto' | 'cancelado', dataPagamento?: string): Promise<void>=>{ if (!animalServico.value || servicosAdicionais.value.length===0) return try{ console.log(`🔄 Sincronizando ${servicosAdicionais.value.length} serviços adicionais com status: ${novoStatus}`) // Atualizar cada serviço adicional para seguir o pai const promessas=servicosAdicionais.value.map(async (adicional)=>{ try{ console.log(`📝 Atualizando serviço adicional ID ${adicional.id} (${adicional.nomeServicoAdicional}) para: ${novoStatus}`) await servicosAdicionaisService.atualizarStatusPagamento( adicional.id, novoStatus, novoStatus==='pago' ? dataPagamento : undefined ) console.log(`✅ Serviço adicional ${adicional.nomeServicoAdicional} sincronizado!`)} catch (error){ console.error(`❌ Erro ao sincronizar serviço adicional ${adicional.nomeServicoAdicional}:`, error)}}) // Aguardar todas as atualizações await Promise.allSettled(promessas) // Recarregar serviços adicionais para mostrar as mudanças await recarregarServicosAdicionais() console.log('🎉 Sincronização de serviços adicionais concluída!')} catch (error){ console.error('❌ Erro geral na sincronização de serviços adicionais:', error)}}// 🎯 Função para alterar status de pagamentoconst alterarStatusPagamento=async (novoStatus: 'pago' | 'em_aberto' | 'cancelado'): Promise<void>=>{ if (!animalServico.value) return try{ alterandoPagamento.value=true mostrarMenuPagamento.value=false console.log(`💳 Alterando status de pagamento para: ${novoStatus}`) let animalServicoAtualizado: AnimalServico let dataPagamento: string | undefined switch (novoStatus){ case 'pago': dataPagamento=new Date().toISOString().split('T')[0] animalServicoAtualizado=await animalServicoService.marcarComoPago(animalServico.value.id, dataPagamento as string) break case 'em_aberto': animalServicoAtualizado=await animalServicoService.reativarServico(animalServico.value.id) break case 'cancelado': if (!confirm(`Tem certeza de que deseja CANCELAR o pagamento deste serviço?`)){ return} animalServicoAtualizado=await animalServicoService.marcarComoCancelado(animalServico.value.id) break} // Atualizar o objeto local animalServico.value=animalServicoAtualizado console.log(`✅ Status de pagamento alterado para: ${getStatusPagamentoTexto(novoStatus)}`) // 🎯 SINCRONIZAR TODOS OS SERVIÇOS ADICIONAIS COM O PAI if (servicosAdicionais.value.length >0){ console.log(`🔄 Iniciando sincronização de ${servicosAdicionais.value.length} serviços adicionais...`) await sincronizarServicosAdicionaisComPai(novoStatus, dataPagamento) // Notificar usuário sobre a sincronização const statusTexto=getStatusPagamentoTexto(novoStatus).toUpperCase() alert(`✅ Status alterado para "${statusTexto}"!\n\n🔄 Todos os ${servicosAdicionais.value.length} serviços adicionais foram automaticamente sincronizados com o mesmo status.`)}} catch (error){ console.error('❌ Erro ao alterar status de pagamento:', error) alert('Erro ao alterar status de pagamento. Tente novamente.')} finally{ alterandoPagamento.value=false}}// 📅 Funções para edição de data de pagamentoconst iniciarEdicaoDataPagamento=(): void=>{ if (!animalServico.value?.dataPagamento) return editandoDataPagamento.value=true novaDataPagamento.value=animalServico.value.dataPagamento mostrarMenuPagamento.value=false // Fechar menu se estiver aberto console.log('📅 Iniciando edição da data de pagamento:', animalServico.value.dataPagamento)}const iniciarDefinicaoDataPagamento=(): void=>{ editandoDataPagamento.value=true novaDataPagamento.value=new Date().toISOString().split('T')[0] as string // Data atual como padrão mostrarMenuPagamento.value=false // Fechar menu se estiver aberto console.log('📅 Iniciando definição da data de pagamento')}const cancelarEdicaoDataPagamento=(): void=>{ editandoDataPagamento.value=false novaDataPagamento.value='' console.log('❌ Cancelando edição da data de pagamento')}const salvarDataPagamento=async (): Promise<void>=>{ if (!animalServico.value || !novaDataPagamento.value){ console.log('❌ Validação falhou:',{ animalServico: !!animalServico.value, novaDataPagamento: novaDataPagamento.value}) return} try{ salvandoDataPagamento.value=true console.log('📋 Estado antes da chamada:',{ id: animalServico.value.id, novaData: novaDataPagamento.value, dataAtual: animalServico.value.dataPagamento, statusAtual: animalServico.value.statusPagamento}) console.log(`💾 Salvando nova data de pagamento: ${novaDataPagamento.value}`) // Usar o endpoint de marcarComoPago com a nova data const animalServicoAtualizado=await animalServicoService.marcarComoPago( animalServico.value.id, novaDataPagamento.value ) console.log('📋 Resposta do servidor:', animalServicoAtualizado) // Atualizar o objeto local animalServico.value=animalServicoAtualizado // Sair do modo de edição editandoDataPagamento.value=false novaDataPagamento.value='' console.log('✅ Data de pagamento atualizada com sucesso!',{ novaDataPagamento: animalServicoAtualizado.dataPagamento}) // 🎯 SINCRONIZAR SERVIÇOS ADICIONAIS QUANDO DATA DE PAGAMENTO MUDA if (servicosAdicionais.value.length >0){ console.log(`🔄 Sincronizando data de pagamento para ${servicosAdicionais.value.length} serviços adicionais...`) await sincronizarServicosAdicionaisComPai('pago', novaDataPagamento.value) // Feedback visual para o usuário alert(`✅ Data de pagamento atualizada com sucesso!\n\n🔄 Todos os ${servicosAdicionais.value.length} serviços adicionais foram sincronizados com a nova data.`)} else{ // Feedback visual normal se não há serviços adicionais alert('✅ Data de pagamento atualizada com sucesso!')}} catch (error){ console.error('❌ Erro detalhado ao atualizar data de pagamento:',{ error, message: error instanceof Error ? error.message : 'Erro desconhecido', stack: error instanceof Error ? error.stack : undefined}) alert(`❌ Erro ao atualizar data de pagamento: ${error instanceof Error ? error.message : 'Erro desconhecido'}`)} finally{ salvandoDataPagamento.value=false}}// 🔧 Métodos para edição de serviços adicionaisconst editarServicoAdicional=(adicional: any): void=>{ servicoAdicionalEditando.value=adicional formularioServicoAdicional.value={ id: adicional.id, servicoId: adicional.servicoAdicionalId, servicoNome: adicional.nomeServicoAdicional, quantidade: adicional.quantidade, valorUnitario: adicional.valorUnitario, valorOriginal: adicional.valorUnitario, observacoes: adicional.observacoes || '', alterarValor: false, dataRealizacao: adicional.dataRealizacao || (animalServico.value?.dataServico || '')} mostrarModalEditarAdicional.value=true}const removerServicoAdicional=async (adicional: any): Promise<void>=>{ if (!confirm(`Deseja realmente remover o serviço "${adicional.nomeServicoAdicional}"?`)) return try{ await servicosAdicionaisService.remover(adicional.id) // Recarregar dados await recarregarServicosAdicionais() console.log('✅ Serviço adicional removido com sucesso!')} catch (error){ console.error('❌ Erro ao remover serviço adicional:', error) alert('Erro ao remover serviço adicional. Tente novamente.')}}const adicionarNovoServicoAdicional=(): void=>{ formularioServicoAdicional.value={ id: null, servicoId: null, // ✅ Alterado de 0 para null - importante para o SearchSelect servicoNome: '', quantidade: 1, valorUnitario: 0, valorOriginal: 0, observacoes: '', alterarValor: false, dataRealizacao: animalServico.value?.dataServico || ''} console.log('🎯 Novo serviço adicional (status e data herdarão do pai automaticamente)') mostrarModalAdicionarExtra.value=true}const salvarServicoAdicional=async (): Promise<void>=>{ if (!animalServico.value) return // ✅ Validar se o serviço foi selecionado if (!formularioServicoAdicional.value.servicoId){ alert('Por favor, selecione um serviço adicional.') return} // ✅ Validar se a quantidade é válida if (!formularioServicoAdicional.value.quantidade || formularioServicoAdicional.value.quantidade < 1){ alert('A quantidade deve ser no mínimo 1.') return} // ✅ Validar se o valor unitário é válido if (formularioServicoAdicional.value.valorUnitario===null || formularioServicoAdicional.value.valorUnitario===undefined || formularioServicoAdicional.value.valorUnitario < 0){ alert('Por favor, informe um valor válido para o serviço.') return} try{ editandoServicos.value=true const dadosServico={ animalServicoPrincipalId: animalServico.value.id, servicoAdicionalId: formularioServicoAdicional.value.servicoId, quantidade: formularioServicoAdicional.value.quantidade, valorUnitario: formularioServicoAdicional.value.valorUnitario, observacoes: formularioServicoAdicional.value.observacoes, usuarioId: usuario.value?.id || null, dataRealizacao: formularioServicoAdicional.value.dataRealizacao || undefined} if (formularioServicoAdicional.value.id){ // Editar existente console.log('🔄 Editando serviço adicional...', dadosServico) const resultado=await servicosAdicionaisService.atualizar(formularioServicoAdicional.value.id, dadosServico) console.log('✅ Serviço adicional editado!') // ✅ Status e data são automaticamente herdados do pai no backend} else{ // Criar novo await servicosAdicionaisService.criar(dadosServico) console.log('✅ Novo serviço adicional criado!')} // Recarregar dados await recarregarServicosAdicionais() // Fechar modais mostrarModalAdicionarExtra.value=false mostrarModalEditarAdicional.value=false} catch (error){ console.error('❌ Erro ao salvar serviço adicional:', error) alert('Erro ao salvar serviço adicional. Tente novamente.')} finally{ editandoServicos.value=false}}const recarregarServicosAdicionais=async (): Promise<void>=>{ if (!animalServico.value) return try{ servicosAdicionais.value=await servicosAdicionaisService.buscarPorAnimalServico(animalServico.value.id) valorTotalAdicionais.value=await servicosAdicionaisService.calcularValorTotal(animalServico.value.id)} catch (error){ console.warn('⚠️ Erro ao recarregar serviços adicionais:', error) servicosAdicionais.value=[] valorTotalAdicionais.value=0}}const atualizarValorServicoSelecionado=(novoValor?: number): void=>{ const servicoId=novoValor || formularioServicoAdicional.value.servicoId const servicoSelecionado=servicosAdicionaisDisponiveis.value.find(s=>s.id===servicoId) if (servicoSelecionado){ formularioServicoAdicional.value.servicoId=servicoId formularioServicoAdicional.value.servicoNome=servicoSelecionado.nome formularioServicoAdicional.value.valorOriginal=servicoSelecionado.valor formularioServicoAdicional.value.valorUnitario=servicoSelecionado.valor formularioServicoAdicional.value.alterarValor=false}}const toggleAlterarValorModal=(): void=>{ if (!formularioServicoAdicional.value.alterarValor){ // Se desmarcou o checkbox, volta ao valor original formularioServicoAdicional.value.valorUnitario=formularioServicoAdicional.value.valorOriginal}}// 🔧 Métodos para edição do serviço principalconst abrirModalEditarServico=(): void=>{ if (!animalServico.value || !servico.value || !usuario.value) return console.log('🔧 Verificando dados disponíveis para SearchSelects:') console.log(' - todosServicos.value.length:', todosServicos.value.length) console.log(' - todosUsuarios.value.length:', todosUsuarios.value.length) console.log(' - servico.value.id atual:', servico.value.id) console.log(' - usuario.value.id atual:', usuario.value.id) formularioEditarServico.value={ servicoId: servico.value.id, usuarioId: usuario.value.id, dataServico: animalServico.value.dataServico, dataExpiracao: animalServico.value.dataExpiracao || '', statusPagamento: animalServico.value.statusPagamento, dataPagamento: animalServico.value.dataPagamento || ''} mostrarModalEditarServico.value=true console.log('🔧 Abrindo modal de edição do serviço principal:', formularioEditarServico.value)}const salvarEdicaoServico=async (): Promise<void>=>{ if (!animalServico.value) return try{ editandoServicos.value=true console.log('💾 Salvando edição do serviço principal...', formularioEditarServico.value) const dadosAtualizacao={ id: animalServico.value.id, dataServico: formularioEditarServico.value.dataServico, dataExpiracao: formularioEditarServico.value.dataExpiracao || undefined, statusPagamento: formularioEditarServico.value.statusPagamento, dataPagamento: formularioEditarServico.value.dataPagamento || undefined, servicoId: formularioEditarServico.value.servicoId || undefined, usuarioId: formularioEditarServico.value.usuarioId || undefined} console.log('📤 Dados sendo enviados para o backend:', dadosAtualizacao) console.log('🔍 IDs específicos:') console.log(' - servicoId:', formularioEditarServico.value.servicoId, typeof formularioEditarServico.value.servicoId) console.log(' - usuarioId:', formularioEditarServico.value.usuarioId, typeof formularioEditarServico.value.usuarioId) console.log('🔍 Valores atuais vs novos:') console.log(' - Serviço atual:', servico.value?.id, servico.value?.nome, 'qtd:', servico.value?.quantidade) console.log(' - Serviço novo:', formularioEditarServico.value.servicoId) console.log(' - Usuário atual:', usuario.value?.id, usuario.value?.nome) console.log(' - Usuário novo:', formularioEditarServico.value.usuarioId) console.log(' - Banhos usados atuais:', animalServico.value?.banhosUsados) const response=await animalServicoService.atualizar(animalServico.value.id, dadosAtualizacao) console.log('✅ Resposta do backend:', response) // Verificar se mudou o serviço para mostrar aviso se necessário const servicoMudou=formularioEditarServico.value.servicoId !==servico.value?.id const servicoNovo=todosServicos.value.find(s=>s.id===formularioEditarServico.value.servicoId) const banhosUsadosAntes=animalServico.value?.banhosUsados || 0 const servicoAnterior=servico.value // Recarregar dados await carregarDados() // 🎯 VERIFICAR SE STATUS DE PAGAMENTO MUDOU PARA SINCRONIZAR SERVIÇOS ADICIONAIS const statusPagamentoMudou=formularioEditarServico.value.statusPagamento !==animalServico.value?.statusPagamento if (statusPagamentoMudou && servicosAdicionais.value.length >0){ console.log(`🔄 Status de pagamento mudou para ${formularioEditarServico.value.statusPagamento}, sincronizando ${servicosAdicionais.value.length} serviços adicionais...`) await sincronizarServicosAdicionaisComPai( formularioEditarServico.value.statusPagamento as 'pago' | 'em_aberto' | 'cancelado', formularioEditarServico.value.statusPagamento==='pago' ? formularioEditarServico.value.dataPagamento : undefined )} // Verificar se houve mudanças nos banhos const banhosUsadosDepois=animalServico.value?.banhosUsados || 0 if (servicoMudou && servicoNovo && servicoAnterior){ const mensagemSync=statusPagamentoMudou && servicosAdicionais.value.length >0 ? `\n\n🔄 ${servicosAdicionais.value.length} serviços adicionais foram sincronizados com o novo status de pagamento.` : ''; if (banhosUsadosAntes >servicoNovo.quantidade){ // Caso onde banhos foram deletados e resetados alert(`🔄 Serviço alterado com limpeza automática!${mensagemSync}\n\n` + `📋 Alteração realizada:\n` + `• De: "${servicoAnterior.nome}" (${servicoAnterior.quantidade} banhos)\n` + `• Para: "${servicoNovo.nome}" (${servicoNovo.quantidade} banhos)\n\n` + `🧹 Limpeza executada:\n` + `• Todos os ${banhosUsadosAntes} banhos anteriores foram removidos\n` + `• Histórico limpo para o novo serviço\n` + `• Contador zerado (${banhosUsadosDepois}/${servicoNovo.quantidade})\n\n` + `✅ Pronto! Agora você pode registrar os banhos do novo serviço.`)} else if (banhosUsadosAntes >banhosUsadosDepois){ // Caso onde apenas o contador foi resetado alert(`🔄 Contador ajustado!${mensagemSync}\n\n` + `Novo serviço "${servicoNovo.nome}" (${servicoNovo.quantidade} banhos).\n` + `Contador: ${banhosUsadosAntes} → ${banhosUsadosDepois}\n\n` + `✅ Você pode registrar novos banhos.`)} else if (statusPagamentoMudou && servicosAdicionais.value.length >0){ // Caso onde só mudou status de pagamento alert(`✅ Serviço alterado com sucesso!${mensagemSync}`)}} else if (statusPagamentoMudou && servicosAdicionais.value.length >0){ // Caso onde só mudou status de pagamento sem alterar serviço const statusTexto=getStatusPagamentoTexto(formularioEditarServico.value.statusPagamento as 'pago' | 'em_aberto' | 'cancelado').toUpperCase() alert(`✅ Status alterado para "${statusTexto}"!\n\n🔄 ${servicosAdicionais.value.length} serviços adicionais foram sincronizados.`)} mostrarModalEditarServico.value=false console.log('✅ Serviço principal atualizado com sucesso!')} catch (error){ console.error('❌ Erro ao salvar edição do serviço:', error) alert('Erro ao salvar alterações. Tente novamente.')} finally{ editandoServicos.value=false}}const carregarDados=async (): Promise<void>=>{ try{ loading.value=true error.value='' console.log('🔍 Carregando dados do Animal Serviço ID:', props.id) // Carregar animal serviço animalServico.value=await animalServicoService.buscarPorId(Number(props.id)) if (!animalServico.value){ error.value='Serviço não encontrado' return} // Carregar dados relacionados const [animaisData, servicosData, clientesData, usuariosData]=await Promise.all([ animaisService.buscarTodos(), servicosService.buscarTodosSimples(), // Usar versão simples para evitar problemas de serialização clientesService.buscarTodos(), usuariosService.buscarTodos() ]) // Salvar serviços e usuários para edição // Para serviços principais: todos exceto os que são APENAS adicionais todosServicos.value=servicosData.filter(s=>{ // Se não tem a propriedade podeSerAdicional ou é false, pode ser principal // Se tem podeSerAdicional=true MAS quantidade >1, também pode ser principal (pacotes) return !s.podeSerAdicional || s.quantidade >1}) todosUsuarios.value=usuariosData // Para serviços adicionais: apenas os marcados como adicionais servicosAdicionaisDisponiveis.value=servicosData.filter(s=>s.podeSerAdicional===true) console.log('🔍 Filtros aplicados:') console.log(' - Serviços principais:', todosServicos.value.map(s=>`${s.nome} (${s.podeSerAdicional ? 'adicional' : 'principal'})`)) console.log(' - Serviços adicionais:', servicosAdicionaisDisponiveis.value.map(s=>s.nome)) console.log('🔍 Dados carregados para SearchSelects:') console.log(' - Todos serviços:', todosServicos.value.length) console.log(' - Todos usuários:', todosUsuarios.value.length) console.log(' - Serviços adicionais:', servicosAdicionaisDisponiveis.value.length) // Preparar descrições para o SearchSelect dos serviços todosServicos.value.forEach(servico=>{ const valorText=`R$ ${servico.valor.toFixed(2).replace('.', ',')}` const quantidadeText=servico.quantidade >1 ? ` • ${servico.quantidade} banhos` : ' • Banho único' const descricaoText=servico.descricao ? ` • ${servico.descricao}` : '' ;(servico as any).servicoDescription=`${valorText}${quantidadeText}${descricaoText}`}) // Preparar descrições para o SearchSelect dos serviços adicionais servicosAdicionaisDisponiveis.value.forEach(servico=>{ const valorText=`R$ ${servico.valor.toFixed(2).replace('.', ',')}` const categoriaText=servico.categoria ? ` • ${servico.categoria}` : '' const descricaoText=servico.descricao ? ` • ${servico.descricao}` : '' ;(servico as any).servicoDescription=`${valorText}${categoriaText}${descricaoText}`}) // Preparar descrições para o SearchSelect dos usuários todosUsuarios.value.forEach(user=>{ ;(user as any).usuarioDescription=`${user.email} • ${user.role}`}) console.log('📝 Exemplos de dados preparados:') console.log(' - Primeiro serviço:', todosServicos.value[0]) console.log(' - Primeiro usuário:', todosUsuarios.value[0]) // Buscar dados específicos - busca reversa devido ao @JsonBackReference animal.value=animaisData.find(a=>a.servicos?.some(s=>s.id===animalServico.value?.id) ) || null // Tentar múltiplas abordagens para encontrar o serviço console.log('🔍 AnimalServico servicoId:', animalServico.value?.servicoId) // Primeiro: tentar usar servicoId se disponível if (animalServico.value?.servicoId){ servico.value=servicosData.find(s=>s.id===animalServico.value?.servicoId) || null} // Segundo: busca reversa através dos servicosAnimais if (!servico.value){ servico.value=servicosData.find(s=>s.servicosAnimais?.some(sa=>sa.id===animalServico.value?.id) ) || null} // Terceiro: busca reversa através do animal (se o animal tem serviços) if (!servico.value && animal.value){ const animalServicoNoAnimal=animal.value.servicos?.find(s=>s.id===animalServico.value?.id) if (animalServicoNoAnimal?.servico){ servico.value=animalServicoNoAnimal.servico}} if (animal.value){ cliente.value=clientesData.find(c=>c.animais?.some(a=>a.id===animal.value?.id) ) || null} // 🔥 CORREÇÃO: usar busca reversa igual à lista (mesma abordagem do AnimalServicoView) usuario.value=usuariosData.find(u=>u.animalServicos?.some(as=>as.id===animalServico.value?.id) ) || null // Se for pacote, carregar banhos individuais if (servico.value && servico.value.quantidade >1){ banhosIndividuais.value=await banhosIndividuaisService.buscarPorAnimalServico(animalServico.value.id)} // Carregar serviços adicionais try{ servicosAdicionais.value=await servicosAdicionaisService.buscarPorAnimalServico(animalServico.value.id) valorTotalAdicionais.value=await servicosAdicionaisService.calcularValorTotal(animalServico.value.id) console.log('✅ Serviços adicionais carregados:', servicosAdicionais.value.length)} catch (error){ console.warn('⚠️ Erro ao carregar serviços adicionais (pode ser normal se não houver):', error) servicosAdicionais.value=[] valorTotalAdicionais.value=0} // Definir data atual para edição novaData.value=animalServico.value.dataServico console.log('✅ Dados carregados:',{ animalServico: animalServico.value, animal: animal.value, servico: servico.value, cliente: cliente.value, banhosIndividuais: banhosIndividuais.value.length}) // Debug: mostrar estrutura dos dados para diagnosticar problemas console.log('🔍 Debug AnimalServico:', animalServico.value) console.log('🔍 VERIFICAR CAMPOS:',{ statusServico: animalServico.value?.statusServico, dataRealizacao: animalServico.value?.dataRealizacao, hasStatusServico: 'statusServico' in (animalServico.value ||{}), hasDataRealizacao: 'dataRealizacao' in (animalServico.value ||{})}) console.log('🔍 Debug Animal encontrado:', animal.value) console.log('🔍 Debug Serviço encontrado:', servico.value) console.log('🔍 Debug Todos os serviços:', servicosData.map(s=>({ id: s.id, nome: s.nome, servicosAnimais: s.servicosAnimais?.length})))} catch (err){ console.error('❌ Erro ao carregar dados:', err) error.value='Erro ao carregar os dados. Tente novamente.'} finally{ loading.value=false}}const voltarParaLista=(): void=>{ router.push('/animal-servico')}const verDetalhesAnimal=(): void=>{ if (animal.value){ router.push(`/animais/${animal.value.id}/editar`)}}const verDetalhesCliente=(): void=>{ if (cliente.value){ router.push(`/clientes/${cliente.value.id}/editar`)}}// Funções de edição da data de realizaçãoconst iniciarEdicaoDataRealizacao=(): void=>{ novaDataRealizacao.value=(animalServico.value?.dataRealizacao || hoje.value) as string editandoDataRealizacao.value=true}const cancelarEdicaoDataRealizacao=(): void=>{ editandoDataRealizacao.value=false novaDataRealizacao.value=''}const salvarDataRealizacao=async (): Promise<void>=>{ try{ if (!animalServico.value || !novaDataRealizacao.value) return // Envia a data exatamente como foi selecionada no input console.log('🔄 Salvando data de realização:', novaDataRealizacao.value) const response=await animalServicoService.atualizar(animalServico.value.id,{ dataRealizacao: novaDataRealizacao.value, statusServico: 'realizado'}) console.log('📥 Resposta do backend:', response) // ⚠️ WORKAROUND: Backend não retorna statusServico/dataRealizacao // Então atualizamos manualmente os campos locais if (animalServico.value){ animalServico.value.dataRealizacao=novaDataRealizacao.value animalServico.value.statusServico='realizado'} editandoDataRealizacao.value=false console.log('✅ Data de realização atualizada com sucesso! (campos atualizados localmente)',{ dataRealizacao: animalServico.value?.dataRealizacao, statusServico: animalServico.value?.statusServico})} catch (err){ console.error('❌ Erro ao atualizar data de realização:', err) alert('Erro ao atualizar a data de realização. Tente novamente.')}}// Funções de alteração de statusconst marcarComoPendente=async (): Promise<void>=>{ try{ if (!animalServico.value) return console.log('🔄 Marcando serviço como pendente...', animalServico.value.id) const response=await animalServicoService.atualizar(animalServico.value.id,{ dataRealizacao: null, statusServico: 'pendente'}) console.log('📥 Resposta do backend:', response) // ⚠️ WORKAROUND: Backend não retorna statusServico/dataRealizacao // Então atualizamos manualmente os campos locais if (animalServico.value){ animalServico.value.dataRealizacao=null animalServico.value.statusServico='pendente'} console.log('✅ Serviço marcado como pendente com sucesso! (campos atualizados localmente)',{ dataRealizacao: animalServico.value?.dataRealizacao, statusServico: animalServico.value?.statusServico})} catch (err){ console.error('❌ Erro ao marcar serviço como pendente:', err) alert('Erro ao atualizar o status do serviço. Tente novamente.')}}const confirmarRealizacaoServico=async (data?: string): Promise<void>=>{ try{ if (!animalServico.value) return // Garantir um valor de data válido: usar data passada, senão usar hoje.value ou fallback para a data atual const dataToUse=data || hoje.value || new Date().toISOString().split('T')[0] console.log('🔄 Marcando serviço como realizado...', animalServico.value.id, 'Data:', dataToUse) const response=await animalServicoService.atualizar(animalServico.value.id,{ dataRealizacao: dataToUse, statusServico: 'realizado'}) console.log('📥 Resposta do backend:', response) // ⚠️ WORKAROUND: Backend não retorna statusServico/dataRealizacao // Então atualizamos manualmente os campos locais if (animalServico.value){ animalServico.value.dataRealizacao=dataToUse animalServico.value.statusServico='realizado'} mostrarModalBanho.value=false console.log('✅ Serviço marcado como realizado com sucesso! (campos atualizados localmente)',{ dataRealizacao: animalServico.value?.dataRealizacao, statusServico: animalServico.value?.statusServico})} catch (err){ console.error('❌ Erro ao marcar serviço como realizado:', err) alert('Erro ao atualizar o status do serviço. Tente novamente.')}}const salvarNovaData=async (): Promise<void>=>{ if (!animalServico.value || !novaData.value) return try{ salvandoData.value=true // Envia a data exatamente como foi selecionada no input console.log('Salvando data do serviço:', novaData.value) const dadosAtualizacao={ id: animalServico.value.id, dataServico: novaData.value, banhosUsados: animalServico.value.banhosUsados, dataExpiracao: animalServico.value.dataExpiracao, statusPagamento: animalServico.value.statusPagamento, dataPagamento: animalServico.value.dataPagamento,} console.log('📤 Enviando dados para API:', dadosAtualizacao) await animalServicoService.atualizar(animalServico.value.id, dadosAtualizacao) animalServico.value.dataServico=novaData.value editarData.value=false console.log('✅ Data atualizada com sucesso!')} catch (err){ console.error('❌ Erro ao atualizar data:', err) alert('Erro ao atualizar a data. Tente novamente.')} finally{ salvandoData.value=false}}// 🗑️ Funções de exclusão do animal serviçoconst confirmarExclusaoAnimalServico=(): void=>{ if (!animalServico.value || !animal.value || !servico.value) return const confirmacao=window.confirm( `🗑️ Tem certeza que deseja excluir este animal serviço?\n\n` + `Animal: ${animal.value.nome}\n` + `Serviço: ${servico.value.nome}\n` + `Data: ${formatarData(animalServico.value.dataServico)}\n` + `Banhos utilizados: ${animalServico.value.banhosUsados}/${servico.value.quantidade}\n\n` + `⚠️ ATENÇÃO: Esta ação não poderá ser desfeita!\n` + `Todos os banhos individuais relacionados também serão excluídos.` ) if (confirmacao){ excluirAnimalServico()}}const excluirAnimalServico=async (): Promise<void>=>{ if (!animalServico.value) return try{ loading.value=true console.log(`🗑️ Excluindo animal serviço ID ${animalServico.value.id}...`) await animalServicoService.excluir(animalServico.value.id) console.log('✅ Animal serviço excluído com sucesso!') // Mostrar feedback de sucesso alert(`✅ Animal serviço de "${animal.value?.nome}" foi excluído com sucesso!\n\nVocê será redirecionado para a lista.`) // Redirecionar para lista voltarParaLista()} catch (err: any){ console.error('❌ Erro ao excluir animal serviço:', err) // apiHelpers já extraiu a mensagem do backend const mensagem=err?.message || 'Erro desconhecido ao excluir serviço' alert(`❌ Não foi possível excluir este serviço\n\n${mensagem}`)} finally{ loading.value=false}}const salvarBanhoIndividual=async (): Promise<void>=>{ if (!animalServico.value || !formularioBanho.value.dataBanho) return try{ salvandoBanho.value=true const dadosBanho={ animalServicoId: animalServico.value.id, dataBanho: formularioBanho.value.dataBanho, observacoes: formularioBanho.value.observacoes || null, usuarioId: null} console.log('🛁 Registrando banho:', dadosBanho) await banhosIndividuaisService.criar(dadosBanho) // Atualizar contador local animalServico.value.banhosUsados=animalServico.value.banhosUsados + 1 // Recarregar banhos individuais if (servico.value && servico.value.quantidade >1){ banhosIndividuais.value=await banhosIndividuaisService.buscarPorAnimalServico(animalServico.value.id)} mostrarModalBanho.value=false formularioBanho.value={ dataBanho: '', observacoes: ''} console.log('✅ Banho registrado com sucesso!')} catch (err){ console.error('❌ Erro ao registrar banho:', err) alert('Erro ao registrar banho. Tente novamente.')} finally{ salvandoBanho.value=false}}const excluirBanho=async (banho: BanhoIndividual): Promise<void>=>{ if (!animalServico.value) return if (!confirm(`Deseja realmente excluir o banho ${banho.numeroBanho}?`)) return try{ await banhosIndividuaisService.excluir(banho.id) // Atualizar contador local animalServico.value.banhosUsados=Math.max(0, animalServico.value.banhosUsados - 1) // Recarregar banhos individuais banhosIndividuais.value=await banhosIndividuaisService.buscarPorAnimalServico(animalServico.value.id) console.log('✅ Banho excluído com sucesso!')} catch (err){ console.error('❌ Erro ao excluir banho:', err) alert('Erro ao excluir banho. Tente novamente.')}}// 📄 Função para gerar relatório PDF (versão simplificada)const gerarRelatorioPDF=async (): Promise<void>=>{ if (!animalServico.value || !animal.value || !cliente.value || !servico.value){ alert('Dados do serviço não carregados completamente. Tente novamente.') return} try{ gerandoPDF.value=true // Criar conteúdo HTML simplificado const htmlContent=` <!DOCTYPE html><html><head><title>Relatório ProntoDog</title><style>body{ font-family: Arial, sans-serif; margin: 20px; background: white; color: black; line-height: 1.6;} h1{ color: #333; text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px;} h2{ color: #333; margin-top: 25px;} p{ margin: 8px 0;} .section{ margin-bottom: 20px; padding: 15px; border-left: 4px solid #007acc; background: #f9f9f9;} .footer{ border-top: 1px solid #ccc; padding-top: 15px; margin-top: 30px; text-align: center; color: #666; font-size: 12px;} @media print{ body{ margin: 0;} .no-print{ display: none;}} </style></head><body><h1>🐕 ProntoDog - Relatório de Serviço</h1><div class="section"><h2>📋 Informações do Serviço</h2><p><strong>ID:</strong>#${animalServico.value.id}</p><p><strong>Data do Serviço:</strong>${formatarData(animalServico.value.dataServico)}</p><p><strong>Data de Geração:</strong>${new Date().toLocaleDateString('pt-BR')}</p></div><div class="section"><h2>👤 Cliente</h2><p><strong>Nome:</strong>${cliente.value.nomeCompleto}</p><p><strong>CPF:</strong>${formatarCpf(cliente.value.cpf)}</p>${cliente.value.telefones?.[0] ? `<p><strong>Telefone:</strong>${formatarTelefone(cliente.value.telefones[0].telefone)}</p>` : ''} ${cliente.value.emailClientes?.[0] ? `<p><strong>Email:</strong>${cliente.value.emailClientes[0].email}</p>` : ''} </div><div class="section"><h2>🐾 Animal</h2><p><strong>Nome:</strong>${animal.value.nome}</p><p><strong>Tipo:</strong>${animal.value.tipo}</p>${animal.value.raca ? `<p><strong>Raça:</strong>${animal.value.raca}</p>` : ''} ${animal.value.peso ? `<p><strong>Peso:</strong>${animal.value.peso}kg</p>` : ''} <p><strong>Código:</strong>${animal.value.codigoSimplesVet}</p></div><div class="section"><h2>💼 Resumo dos Serviços</h2><div style="margin-bottom: 15px; padding: 10px; background: #f3f4f6; border-radius: 5px;"><h3 style="margin: 0 0 8px 0; color: #4f46e5;">⭐ Serviço Principal</h3><p><strong>Serviço:</strong>${servico.value.nome}</p><p><strong>Valor:</strong>R$ ${servico.value.valor.toFixed(2).replace('.', ',')}</p><p><strong>Quantidade de Banhos:</strong>${servico.value.quantidade}</p><p><strong>Banhos Utilizados:</strong>${animalServico.value.banhosUsados}</p><p><strong>Banhos Restantes:</strong>${Math.max(0, servico.value.quantidade - animalServico.value.banhosUsados)}</p><p><strong>Status:</strong>${isServicoCompleto.value ? 'COMPLETO' : 'EM ANDAMENTO'}</p></div>${servicosAdicionais.value.length >0 ? ` <div style="margin-bottom: 15px;"><h3 style="margin: 0 0 10px 0; color: #f59e0b;">➕ Serviços Adicionais</h3>${servicosAdicionais.value.map(adicional=>` <div style="margin-bottom: 8px; padding: 8px; background: #fef3c7; border-radius: 3px;"><p><strong>${adicional.nomeServicoAdicional}</strong></p><p>Quantidade: ${adicional.quantidade} • Valor Unitário: R$ ${adicional.valorUnitario.toFixed(2).replace('.', ',')} • Total: R$ ${adicional.valorTotal.toFixed(2).replace('.', ',')}</p><p>Status: ${adicional.statusPagamento==='pago' ? 'PAGO' : adicional.statusPagamento==='cancelado' ? 'CANCELADO' : 'EM ABERTO'}</p>${adicional.observacoes ? `<p>Obs: ${adicional.observacoes}</p>` : ''} </div>`).join('')} </div>` : ''} <div style="margin-top: 15px; padding: 10px; background: #10b981; color: white; border-radius: 5px; text-align: center;"><h3 style="margin: 0;">💰 VALOR TOTAL GERAL: R$ ${valorTotalGeral.value.toFixed(2).replace('.', ',')}</h3>${servicosAdicionais.value.length >0 ? ` <p style="margin: 5px 0 0 0; font-size: 12px;">Principal: R$ ${valorTotalPrincipal.value.toFixed(2).replace('.', ',')} + Adicionais: R$ ${valorTotalAdicionais.value.toFixed(2).replace('.', ',')}</p>` : ''} </div></div><div class="section"><h2>💳 Pagamento</h2><p><strong>Status:</strong>${getStatusPagamentoTexto(animalServico.value.statusPagamento).toUpperCase()}</p>${animalServico.value.dataPagamento ? `<p><strong>Data do Pagamento:</strong>${formatarData(animalServico.value.dataPagamento)}</p>` : ''} ${animalServico.value.dataExpiracao ? `<p><strong>Data de Expiração:</strong>${formatarData(animalServico.value.dataExpiracao)}</p>` : ''} </div>${banhosIndividuais.value.length >0 ? ` <div class="section"><h2>🛁 Histórico de Banhos</h2>${banhosIndividuais.value.map(banho=>` <p><strong>Banho #${banho.numeroBanho}:</strong>${formatarData(banho.dataBanho)}${banho.observacoes ? ` - ${banho.observacoes}` : ''}</p>`).join('')} </div>` : ''} <div class="footer"><p>Relatório gerado automaticamente pelo Sistema ProntoDog</p><p>© ${new Date().getFullYear()} ProntoDog - Sistema de Gestão Pet</p></div><div class="no-print" style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 8px; text-align: center;"><h3 style="color: #1976d2; margin-top: 0;">📄 Para salvar como PDF:</h3><p><strong>1.</strong>Pressione <kbd style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; border: 1px solid #ccc;">Ctrl+P</kbd>(Windows) ou <kbd style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; border: 1px solid #ccc;">Cmd+P</kbd>(Mac)</p><p><strong>2.</strong>Na tela de impressão, escolha <strong>"Salvar como PDF"</strong></p><p><strong>3.</strong>Escolha o local e clique em <strong>"Salvar"</strong></p></div></body></html>` // Abrir nova janela com o relatório const printWindow=window.open('', '_blank', 'width=800,height=600') if (printWindow){ printWindow.document.write(htmlContent) printWindow.document.close() // Aguardar carregar e abrir impressão printWindow.onload=()=>{ setTimeout(()=>{ printWindow.print()}, 500)} console.log('✅ Relatório aberto em nova janela')} else{ alert('❌ Não foi possível abrir o relatório. Verifique se pop-ups estão bloqueados no navegador.')}} catch (err){ console.error('❌ Erro ao gerar relatório:', err) alert('❌ Erro ao gerar o relatório. Tente novamente.')} finally{ gerandoPDF.value=false}}// LifecycleonMounted(()=>{ carregarDados() // Definir data padrão para novo banho formularioBanho.value.dataBanho=new Date().toISOString().split('T')[0] || ''})</script><style scoped>@keyframes fade-in-up{ from{ opacity: 0; transform: translateY(30px);} to{ opacity: 1; transform: translateY(0);}}.animate-fade-in-up{ animation: fade-in-up 0.6s ease-out forwards}@keyframes bounce-gentle{ 0%, 20%, 50%, 80%, 100%{ transform: translateY(0);} 40%{ transform: translateY(-10px);} 60%{ transform: translateY(-5px);}}.animate-bounce-gentle{ animation: bounce-gentle 2s infinite}</style>