<template><div class="min-h-screen bg-gradient-to-br from-emerald-50 via-white to-teal-100"><div class="relative overflow-hidden bg-gradient-to-r from-emerald-600 via-teal-600 to-emerald-700 text-white pt-16"><div class="absolute inset-0 opacity-10 bg-pattern"></div><div class="relative px-6 py-8 z-20"><div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6"><div class="flex items-center gap-4 animate-fade-in-up"><div class="relative"><div class="w-16 h-16 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl flex items-center justify-center transform hover:scale-110 transition-all duration-300 shadow-lg"><FontAwesomeIcon :icon="['fas', 'chart-line']" class="text-2xl text-white animate-bounce-gentle" /></div><div v-if="animalSelecionado" class="absolute -top-1 -right-1 w-8 h-8 bg-yellow-400 rounded-full flex items-center justify-center animate-pulse"><FontAwesomeIcon :icon="['fas', 'check']" class="text-xs text-yellow-800" /></div></div><div class="space-y-1"><h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-emerald-100">Histórico por Animal </h1><p class="text-white text-lg flex items-center gap-2 font-medium opacity-90"><FontAwesomeIcon :icon="['fas', 'paw']" class="text-yellow-400 animate-twinkle mr-1" />{{ animalSelecionado ? `Histórico de ${animalSelecionado.nome}` : 'Selecione um animal para ver o histórico'}} </p></div></div><div class="flex items-center gap-3"><button v-if="animalSelecionado" @click="carregarHistorico" :disabled="carregandoHistorico" class="group flex items-center gap-2 px-4 py-2 bg-white bg-opacity-20 backdrop-blur-sm text-white rounded-xl hover:bg-opacity-30 transition-all duration-300 border border-white border-opacity-20 hover:border-opacity-40 transform hover:-translate-y-1 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" ><FontAwesomeIcon :icon="carregandoHistorico ? ['fas', 'spinner'] : ['fas', 'refresh']" :class="{ 'animate-spin': carregandoHistorico, 'group-hover:rotate-180': !carregandoHistorico}" class="transition-transform duration-300" /><span class="font-medium">{{ carregandoHistorico ? 'Carregando...' : 'Atualizar'}}</span></button></div></div></div></div><div class="relative px-6 py-8"><div class="max-w-4xl mx-auto mb-8"><div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-200/50 p-6"><div class="flex items-center gap-3 mb-4"><div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center shadow-lg"><FontAwesomeIcon :icon="['fas', 'filter']" class="text-white text-lg" /></div><div><h2 class="font-bold text-gray-800 text-lg">Filtros de Busca</h2><p class="text-gray-600 text-sm">Refine sua pesquisa por nome, tipo, raça ou cliente</p></div></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Nome do Animal</label><input v-model="filtros.nome" type="text" placeholder="Digite o nome..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 transition-all" @input="debouncedBuscar" /></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label><select v-model="filtros.tipo" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 transition-all" @change="buscarAnimaisFiltrados" ><option value="">Todos os tipos</option><option value="cachorro">Cachorro</option><option value="gato">Gato</option><option value="coelho">Coelho</option><option value="outros">Outros</option></select></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Raça</label><input v-model="filtros.raca" type="text" placeholder="Digite a raça..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 transition-all" @input="debouncedBuscar" /></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label><input v-model="filtros.clienteNome" type="text" placeholder="Nome do cliente..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 transition-all" @input="debouncedBuscar" /></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Código</label><input v-model="filtros.codigoSimplesVet" type="text" placeholder="Código SimplesVet..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 transition-all" @input="debouncedBuscar" /></div><div class="flex items-end gap-2"><button @click="limparFiltros" :disabled="!temFiltrosPreenchidos" class="px-4 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-all font-medium disabled:opacity-50 disabled:cursor-not-allowed" >Limpar </button><button @click="buscarAnimaisFiltrados" :disabled="carregandoAnimais || !temFiltrosPreenchidos" class="px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl hover:from-emerald-600 hover:to-teal-600 transition-all font-medium disabled:opacity-50 disabled:cursor-not-allowed" :title="!temFiltrosPreenchidos ? 'Preencha pelo menos um filtro para buscar' : ''" >{{ carregandoAnimais ? 'Buscando...' : temFiltrosPreenchidos ? 'Buscar' : 'Preencha um filtro'}} </button></div></div></div></div><div class="max-w-4xl mx-auto mb-8"><div class="relative bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-200/50 p-6 hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1"><div class="flex items-center gap-3 mb-4"><div class="w-12 h-12 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-xl flex items-center justify-center shadow-lg"><FontAwesomeIcon :icon="['fas', 'search']" class="text-white text-lg" /></div><div><h2 class="font-bold text-gray-800 text-lg">Buscar Animal</h2><p class="text-gray-600 text-sm">Selecione um animal para ver seu histórico completo</p></div></div><SearchSelect v-model="animalSelecionadoId" :options="animais" :loading="carregandoAnimais" placeholder="Selecione um animal da lista filtrada..." value-key="id" label-key="nome" description-key="animalDescription" @update:modelValue="onAnimalSelecionado" /><div v-if="paginacao.totalElements >0" class="mt-4 text-sm text-gray-600 text-center"><div class="flex items-center justify-center gap-2"><FontAwesomeIcon :icon="['fas', 'list']" class="text-emerald-600" /><span>{{ paginacao.totalElements}}{{ paginacao.totalElements===1 ? 'animal encontrado' : 'animais encontrados'}}</span><span v-if="paginacao.totalElements >=100" class="text-amber-600 font-medium">(mostrando primeiros 100) </span></div></div></div></div><div v-if="animalSelecionado && resumo" class="max-w-4xl mx-auto mb-8"><div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-200/50 p-6 hover:shadow-2xl transition-all duration-300"><div class="flex items-center gap-3 mb-6"><div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl flex items-center justify-center shadow-lg"><FontAwesomeIcon :icon="['fas', 'chart-pie']" class="text-white text-lg" /></div><div><h2 class="font-bold text-gray-800 text-xl">Resumo Geral</h2><p class="text-gray-600">{{ animalSelecionado.tipo}} -{{ animalSelecionado.raca || 'Raça não informada'}}</p></div></div><div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div class="bg-gradient-to-br from-green-50 to-emerald-100 rounded-xl p-4 border border-green-200"><div class="flex items-center gap-2 mb-2"><FontAwesomeIcon :icon="['fas', 'money-bill-wave']" class="text-green-600" /><span class="text-sm font-medium text-green-800">Total Gasto</span></div><p class="text-2xl font-bold text-green-900">R${{ resumo.totalGasto.toFixed(2)}}</p></div><div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-xl p-4 border border-blue-200"><div class="flex items-center gap-2 mb-2"><FontAwesomeIcon :icon="['fas', 'list']" class="text-blue-600" /><span class="text-sm font-medium text-blue-800">Serviços</span></div><p class="text-2xl font-bold text-blue-900">{{ resumo.totalServicos}}</p></div><div class="bg-gradient-to-br from-purple-50 to-violet-100 rounded-xl p-4 border border-purple-200"><div class="flex items-center gap-2 mb-2"><FontAwesomeIcon :icon="['fas', 'calendar-plus']" class="text-purple-600" /><span class="text-sm font-medium text-purple-800">Cliente desde</span></div><p class="text-lg font-bold text-purple-900">{{ formatarData(resumo.primeiroServico)}}</p></div><div class="bg-gradient-to-br from-amber-50 to-orange-100 rounded-xl p-4 border border-amber-200"><div class="flex items-center gap-2 mb-2"><FontAwesomeIcon :icon="['fas', 'circle']" class="text-amber-600" /><span class="text-sm font-medium text-amber-800">Status</span></div><p class="text-lg font-bold" :class="resumo.temServicoAtivo ? 'text-orange-900' : 'text-amber-900'">{{ resumo.temServicoAtivo ? 'Ativo' : 'Em Dia'}} </p></div></div></div></div><div v-if="animalSelecionado && servicos.length >0" class="max-w-4xl mx-auto"><div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-200/50 p-6 hover:shadow-2xl transition-all duration-300"><div class="flex items-center gap-3 mb-6"><div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center shadow-lg"><FontAwesomeIcon :icon="['fas', 'history']" class="text-white text-lg" /></div><div><h2 class="font-bold text-gray-800 text-xl">Histórico de Serviços</h2><p class="text-gray-600">Timeline cronológica de todos os serviços</p></div></div><div class="space-y-4"><div v-for="(servico, index) in servicos" :key="servico.id" class="relative border-l-4 pl-6 pb-6" :class="getStatusBorderClass(servico.statusServico)" ><div class="absolute -left-2 w-4 h-4 rounded-full border-4 border-white shadow-lg" :class="getStatusBgClass(servico.statusServico)"></div><div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-all duration-200"><div class="flex items-start justify-between mb-3"><div class="flex-1"><div class="flex items-center gap-3 mb-2"><h3 class="font-bold text-gray-800 text-lg">{{ servico.servico.nome}}</h3><span class="px-3 py-1 rounded-full text-sm font-medium" :class="getStatusTextClass(servico.statusServico)">{{ getStatusTexto(servico.statusServico)}} </span></div><div class="flex items-center gap-4 text-sm text-gray-600"><div class="flex items-center gap-1"><FontAwesomeIcon :icon="['fas', 'calendar-alt']" class="text-gray-500 text-xs" /><span>{{ formatarData(servico.dataServico)}}</span></div><div v-if="!servico.servico.podeSerAdicional" class="flex items-center gap-1"><FontAwesomeIcon :icon="['fas', 'shower']" class="text-blue-500 text-xs" /><span>{{ servico.banhosRealizados}}/{{ servico.servico.quantidade}} banhos</span></div><div class="flex items-center gap-1"><FontAwesomeIcon :icon="['fas', 'dollar-sign']" class="text-green-500 text-xs" /><span>R${{ servico.valorTotal.toFixed(2)}}</span></div><div v-if="servico.usuario" class="flex items-center gap-1"><FontAwesomeIcon :icon="['fas', 'user']" class="text-purple-500 text-xs" /><span>{{ servico.usuario.nome}}</span></div></div></div><div class="flex items-center gap-2"><button @click="$router.push(`/animal-servico/${servico.id}`)" class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-lg hover:bg-emerald-200 transition-all text-sm font-medium" >Ver Detalhes </button></div></div><div v-if="servico.servicosAdicionais && servico.servicosAdicionais.length >0" class="mt-3 pt-3 border-t border-gray-200"><div class="flex items-center gap-2 mb-2"><FontAwesomeIcon :icon="['fas', 'plus-circle']" class="text-blue-600 text-sm" /><p class="text-sm font-medium text-gray-700">Serviços Extras:</p></div><div class="flex flex-wrap gap-2"><div v-for="adicional in servico.servicosAdicionais" :key="adicional.id" class="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-700 rounded-lg border border-blue-200 text-xs font-medium" ><FontAwesomeIcon :icon="['fas', 'tag']" class="text-blue-500" /><span>{{ adicional.nome}}</span><span class="text-blue-500">({{ adicional.quantidade}}x)</span><span class="font-bold">R${{ adicional.valorTotal.toFixed(2)}}</span></div></div></div></div></div></div></div></div><div v-else-if="animalSelecionado && servicos.length===0 && !carregandoHistorico" class="max-w-md mx-auto text-center"><div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200/50 p-8"><FontAwesomeIcon :icon="['fas', 'inbox']" class="text-6xl text-gray-400 mb-4" /><h3 class="text-xl font-bold text-gray-800 mb-2">Nenhum serviço encontrado</h3><p class="text-gray-600">Este animal ainda não possui histórico de serviços.</p></div></div><div v-if="carregandoHistorico" class="max-w-md mx-auto text-center"><div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-emerald-200/50 p-8"><FontAwesomeIcon :icon="['fas', 'spinner']" class="text-4xl text-emerald-600 mb-4 animate-spin" /><h3 class="text-xl font-bold text-gray-800 mb-2">Carregando histórico...</h3><p class="text-gray-600">Aguarde enquanto buscamos os dados do animal.</p></div></div></div></div></template><script setup lang="ts">import{ ref, reactive, computed, onMounted} from 'vue'import{ FontAwesomeIcon} from '@fortawesome/vue-fontawesome'import SearchSelect from '@/components/UI/SearchSelect.vue'import{ animaisService} from '@/services/api'import type{ Animal} from '@/types/api'import{ formatarDataSegura} from '@/utils/formatters'// Estados reativosconst animalSelecionadoId=ref<number | string>('')const animalSelecionado=ref<Animal | null>(null)const carregandoAnimais=ref(false)const carregandoHistorico=ref(false)// Dadosconst animais=ref<Animal[]>([])const resumo=ref<any>(null)const servicos=ref<any[]>([])// Filtros e paginaçãoconst filtros=ref({ nome: '', tipo: '', raca: '', codigoSimplesVet: '', clienteNome: ''})const paginacao=ref({ page: 0, size: 100, // Carregar mais animais por vez totalElements: 0, totalPages: 0, sortBy: 'nome', sortDir: 'asc'})// Verificar se há filtros preenchidosconst temFiltrosPreenchidos=computed(()=>{ return Boolean( filtros.value.nome?.trim() || filtros.value.tipo?.trim() || filtros.value.raca?.trim() || filtros.value.codigoSimplesVet?.trim() || filtros.value.clienteNome?.trim() )})// 📝 Preparar dados dos animais com descriçõesconst prepararDadosAnimais=(): void=>{ animais.value.forEach(animal=>{ (animal as any).animalDescription=`${animal.tipo} - ${animal.cliente?.nomeCompleto || 'Cliente não informado'} - Código: ${animal.codigoSimplesVet || 'N/A'}`})}// Debounce para buscalet debounceTimeout: number | null=nullconst debouncedBuscar=(): void=>{ if (debounceTimeout){ clearTimeout(debounceTimeout)} debounceTimeout=setTimeout(()=>{ if (temFiltrosPreenchidos.value){ paginacao.value.page=0 // Reset para primeira página buscarAnimaisFiltrados()} else{ // Se não há filtros, limpa os resultados animais.value=[] paginacao.value.totalElements=0 paginacao.value.totalPages=0 animalSelecionado.value=null resumo.value=null servicos.value=[]}}, 500) // 500ms de delay}// Buscar animais com filtrosconst buscarAnimaisFiltrados=async (): Promise<void>=>{ if (carregandoAnimais.value) return // Verifica se há pelo menos um filtro preenchido if (!temFiltrosPreenchidos.value){ console.log('Nenhum filtro preenchido, busca cancelada') return} try{ carregandoAnimais.value=true console.log('Buscando animais com filtros...', filtros.value) const resultado=await animaisService.buscarComFiltros({ nome: filtros.value.nome || undefined, tipo: filtros.value.tipo || undefined, raca: filtros.value.raca || undefined, codigoSimplesVet: filtros.value.codigoSimplesVet || undefined, clienteNome: filtros.value.clienteNome || undefined, page: paginacao.value.page, size: paginacao.value.size, sortBy: paginacao.value.sortBy, sortDir: paginacao.value.sortDir}) animais.value=resultado.content || [] paginacao.value={ ...paginacao.value, page: resultado.number || 0, totalElements: resultado.totalElements || 0, totalPages: resultado.totalPages || 0} prepararDadosAnimais() console.log('Animais carregados:',{ total: paginacao.value.totalElements, pagina: paginacao.value.page + 1, totalPaginas: paginacao.value.totalPages})} catch (error){ console.error('Erro ao buscar animais:', error) animais.value=[] paginacao.value.totalElements=0 paginacao.value.totalPages=0} finally{ carregandoAnimais.value=false}}// Limpar filtrosconst limparFiltros=(): void=>{ filtros.value={ nome: '', tipo: '', raca: '', codigoSimplesVet: '', clienteNome: ''} paginacao.value.page=0 buscarAnimaisFiltrados()}// Quando animal é selecionadoconst onAnimalSelecionado=(animalId: number | string): void=>{ if (!animalId){ animalSelecionado.value=null resumo.value=null servicos.value=[] return} const animal=animais.value.find(a=>a.id===Number(animalId)) if (animal){ animalSelecionado.value=animal carregarHistorico()}}// Carregar histórico do animal selecionadoconst carregarHistorico=async (): Promise<void>=>{ if (!animalSelecionado.value || carregandoHistorico.value) return try{ carregandoHistorico.value=true console.log('Carregando histórico do animal:', animalSelecionado.value.id) const dados=await animaisService.buscarHistorico(animalSelecionado.value.id) resumo.value=dados.resumo servicos.value=dados.servicos console.log('Histórico carregado:', dados)} catch (error){ console.error('Erro ao carregar histórico:', error) resumo.value=null servicos.value=[]} finally{ carregandoHistorico.value=false}}// Classes de estilo baseadas no statusconst getStatusBorderClass=(status: string): string=>{ const classes={ 'completo': 'border-green-400', 'realizado': 'border-green-400', 'em_andamento': 'border-blue-400', 'nao_iniciado': 'border-gray-400', 'pendente': 'border-yellow-400'} return classes[status as keyof typeof classes] || 'border-gray-400'}const getStatusBgClass=(status: string): string=>{ const classes={ 'completo': 'bg-green-400', 'realizado': 'bg-green-400', 'em_andamento': 'bg-blue-400', 'nao_iniciado': 'bg-gray-400', 'pendente': 'bg-yellow-400'} return classes[status as keyof typeof classes] || 'bg-gray-400'}const getStatusTextClass=(status: string): string=>{ const classes={ 'completo': 'bg-green-100 text-green-800', 'realizado': 'bg-green-100 text-green-800', 'em_andamento': 'bg-blue-100 text-blue-800', 'nao_iniciado': 'bg-gray-100 text-gray-800', 'pendente': 'bg-yellow-100 text-yellow-800'} return classes[status as keyof typeof classes] || 'bg-gray-100 text-gray-800'}const getStatusTexto=(status: string): string=>{ const textos={ 'completo': 'Completo', 'realizado': 'Realizado', 'em_andamento': 'Em Andamento', 'nao_iniciado': 'Não Iniciado', 'pendente': 'Pendente'} return textos[status as keyof typeof textos] || status}// Formatar dataconst formatarData=(data: string | null): string=>{ if (!data) return 'N/A' return formatarDataSegura(data)}// InicializaçãoonMounted(()=>{ console.log('Componente montado! Aguardando filtros para buscar...') // Não busca automaticamente - aguarda o usuário preencher filtros})</script><style scoped>.bg-pattern{ background-image: radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%)}.animate-fade-in-up{ animation: fadeInUp 0.6s ease-out}.animate-bounce-gentle{ animation: bounceGentle 2s infinite}.animate-twinkle{ animation: twinkle 1.5s infinite}@keyframes fadeInUp{ from{ opacity: 0; transform: translateY(20px);} to{ opacity: 1; transform: translateY(0);}}@keyframes bounceGentle{ 0%, 20%, 50%, 80%, 100%{ transform: translateY(0);} 40%{ transform: translateY(-5px);} 60%{ transform: translateY(-3px);}}@keyframes twinkle{ 0%, 100%{ opacity: 1; transform: scale(1);} 50%{ opacity: 0.7; transform: scale(1.1);}}</style>