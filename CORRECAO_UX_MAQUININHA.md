# üé® Corre√ß√£o de UX - Ordem dos Campos e L√≥gica de Parcelas

## üêõ PROBLEMAS IDENTIFICADOS

### **Problema 1: Ordem dos Campos Errada**

‚ùå Campo "Bandeira do Cart√£o" aparecia **ANTES** do "Tipo de Transa√ß√£o"

- N√£o faz sentido, pois bandeira depende do tipo!
- Usu√°rio tinha que selecionar bandeira sem saber qual tipo usaria

### **Problema 2: D√©bito e PIX N√£o Podem Ser Parcelados**

‚ùå Sistema permitia selecionar m√∫ltiplas parcelas mesmo com d√©bito ou PIX selecionado

- D√©bito sempre √© √† vista (1x)
- PIX sempre √© √† vista (1x)
- Campo de parcelas deveria estar desabilitado

### **Problema 3: L√≥gica de Cr√©dito Parcelado**

‚ùå N√£o validava se a forma de pagamento permitia parcelamento

- Deveria verificar `parcelasMax > 1` antes de mostrar op√ß√£o de cr√©dito parcelado

---

## ‚úÖ SOLU√á√ïES IMPLEMENTADAS

### **1. Ordem Correta dos Campos**

**Antes:**

```
1. Bandeira do Cart√£o ‚Üê ANTES
2. Tipo de Transa√ß√£o ‚Üê DEPOIS
```

**Depois:**

```
1. Tipo de Transa√ß√£o ‚Üê PRIMEIRO (l√≥gico!)
2. Bandeira do Cart√£o ‚Üê DEPOIS (depende do tipo)
```

---

### **2. D√©bito e PIX Travam Parcelas em 1x**

**Comportamento Novo:**

- ‚úÖ Ao selecionar **D√©bito** ou **PIX**, parcelas √© travado em **1x**
- ‚úÖ Campo de parcelas fica **desabilitado** (cinza)
- ‚úÖ Mensagem informativa: "(d√©bito n√£o pode ser parcelado)" ou "(PIX n√£o pode ser parcelado)"

**Fluxo:**

```
1. Usu√°rio seleciona "D√©bito" ou "PIX"
   ‚Üì
2. Sistema automaticamente:
   - formPagamento.numeroParcelas = 1
   - Desabilita campo de parcelas
   - Limpa bandeira selecionada (se houver)
   ‚Üì
3. Usu√°rio v√™:
   [Parcelas: 1x ‚ñº] (desabilitado)
   (d√©bito n√£o pode ser parcelado) OU (PIX n√£o pode ser parcelado)
```

---

### **3. Valida√ß√£o de Cr√©dito Parcelado**

**Computed Properties Criadas:**

```typescript
// Pode usar cr√©dito √† vista?
const podeUsarCreditoAVista = computed(() => {
  return formPagamento.value.numeroParcelas === 1;
});

// Pode usar cr√©dito parcelado?
const podeUsarCreditoParcelado = computed(() => {
  const forma = formaPagamentoSelecionada.value;
  // S√≥ pode parcelar se:
  // 1. Tiver mais de 1 parcela selecionada
  // 2. Forma de pagamento permitir parcelamento (parcelasMax > 1)
  return (
    formPagamento.value.numeroParcelas > 1 && (forma?.parcelasMax || 1) > 1
  );
});
```

**No Template:**

```html
<option value="credito_avista" v-if="podeUsarCreditoAVista">
  Cr√©dito √† Vista
</option>
<option value="credito_parcelado" v-if="podeUsarCreditoParcelado">
  Cr√©dito Parcelado ({{ formPagamento.numeroParcelas }}x)
</option>
```

---

## üîß MUDAN√áAS NO C√ìDIGO

### **1. Template - Ordem dos Campos Invertida**

**Antes:**

```html
<!-- 1¬∫: Bandeira -->
<div v-if="formPagamento.maquininhaId">
  <label>Bandeira do Cart√£o</label>
  <select v-model="formPagamento.bandeiraId">
    ...
  </select>
</div>

<!-- 2¬∫: Tipo -->
<div v-if="formPagamento.maquininhaId">
  <label>Tipo de Transa√ß√£o</label>
  <select v-model="tipoTransacaoManual">
    ...
  </select>
</div>
```

**Depois:**

```html
<!-- 1¬∫: Tipo (PRIMEIRO!) -->
<div v-if="formPagamento.maquininhaId">
  <label>Tipo de Transa√ß√£o</label>
  <select v-model="tipoTransacaoManual">
    <option value="">Selecione o tipo...</option>
    <option value="debito">D√©bito</option>
    <option value="credito_avista" v-if="podeUsarCreditoAVista">
      Cr√©dito √† Vista
    </option>
    <option value="credito_parcelado" v-if="podeUsarCreditoParcelado">
      Cr√©dito Parcelado ({{ formPagamento.numeroParcelas }}x)
    </option>
    <option value="pix" v-if="maquininhaSelecionadaAceitaPix">PIX</option>
  </select>
</div>

<!-- 2¬∫: Bandeira (s√≥ aparece DEPOIS de selecionar tipo) -->
<div
  v-if="formPagamento.maquininhaId && tipoTransacaoManual && tipoTransacaoManual !== 'pix'"
>
  <label>Bandeira do Cart√£o</label>
  <select v-model="formPagamento.bandeiraId">
    ...
  </select>
</div>
```

**Mudan√ßas:**

- ‚úÖ Tipo aparece **primeiro**
- ‚úÖ Bandeira s√≥ aparece **se tipo estiver selecionado**
- ‚úÖ Bandeira **n√£o aparece** se tipo for PIX

---

### **2. Campo de Parcelas - Desabilita para D√©bito**

**Antes:**

```html
<select v-model.number="formPagamento.numeroParcelas">
  <option v-for="n in formaPagamentoSelecionada.parcelasMax">
    {{ n }}x de ...
  </option>
</select>
```

**Depois:**

```html
<label>
  Parcelas
  <span v-if="tipoTransacaoManual === 'debito'" class="text-orange-600">
    (d√©bito n√£o pode ser parcelado)
  </span>
  <span v-else-if="tipoTransacaoManual === 'pix'" class="text-orange-600">
    (PIX n√£o pode ser parcelado)
  </span>
</label>
<select
  v-model.number="formPagamento.numeroParcelas"
  :disabled="tipoTransacaoManual === 'debito' || tipoTransacaoManual === 'pix'"
  :class="[
    'w-full px-4 py-2 border rounded-lg',
    tipoTransacaoManual === 'debito' || tipoTransacaoManual === 'pix'
      ? 'bg-gray-100 cursor-not-allowed'
      : 'focus:ring-2 focus:ring-violet-500'
  ]"
>
  <option v-for="n in formaPagamentoSelecionada.parcelasMax">
    {{ n }}x de ...
  </option>
</select>
```

**Mudan√ßas:**

- ‚úÖ `:disabled="tipoTransacaoManual === 'debito' || tipoTransacaoManual === 'pix'"` - desabilita para d√©bito e PIX
- ‚úÖ Classes condicionais - cinza quando desabilitado
- ‚úÖ Mensagem informativa quando d√©bito ou PIX

---

### **3. Watcher - Trava Parcelas quando D√©bito ou PIX**

**Novo Watcher:**

```typescript
watch(
  () => tipoTransacaoManual.value,
  (novoTipo) => {
    // PIX: limpa bandeira E trava em 1x (PIX n√£o parcela!)
    if (novoTipo === "pix") {
      formPagamento.value.bandeiraId = null;
      formPagamento.value.numeroParcelas = 1; // ‚Üê FOR√áA 1x
    }

    // D√âBITO: trava em 1 parcela + limpa bandeira
    if (novoTipo === "debito") {
      formPagamento.value.numeroParcelas = 1; // ‚Üê FOR√áA 1x
      formPagamento.value.bandeiraId = null;
    }

    calculoMaquininha.value = null;
  }
);
```

**Comportamento:**

- ‚úÖ Ao selecionar d√©bito ou PIX ‚Üí for√ßa `numeroParcelas = 1`
- ‚úÖ Limpa bandeira para recalcular
- ‚úÖ Limpa c√°lculo para for√ßar recalcular

---

### **4. Computed Properties - Valida√ß√£o de Cr√©dito**

**Adicionados:**

```typescript
// Verificar se pode usar cr√©dito √† vista
const podeUsarCreditoAVista = computed(() => {
  return formPagamento.value.numeroParcelas === 1;
});

// Verificar se pode usar cr√©dito parcelado
const podeUsarCreditoParcelado = computed(() => {
  const forma = formaPagamentoSelecionada.value;
  // S√≥ pode parcelar se:
  // 1. Tiver mais de 1 parcela selecionada
  // 2. Forma de pagamento permitir parcelamento (parcelasMax > 1)
  return (
    formPagamento.value.numeroParcelas > 1 && (forma?.parcelasMax || 1) > 1
  );
});
```

**Uso no Template:**

```html
<option value="credito_avista" v-if="podeUsarCreditoAVista">
  Cr√©dito √† Vista
</option>
<option value="credito_parcelado" v-if="podeUsarCreditoParcelado">
  Cr√©dito Parcelado ({{ formPagamento.numeroParcelas }}x)
</option>
```

---

## üìä FLUXOS COMPLETOS

### **Fluxo 1: Pagamento com D√©bito**

```
1Ô∏è‚É£ Usu√°rio seleciona forma de pagamento via maquininha
   ‚Üì
2Ô∏è‚É£ Aparece campo "Tipo de Transa√ß√£o" (PRIMEIRO!)
   ‚Üì
3Ô∏è‚É£ Usu√°rio seleciona: "D√©bito"
   ‚Üì
4Ô∏è‚É£ Sistema automaticamente:
   ‚úÖ Trava parcelas em 1x
   ‚úÖ Desabilita campo de parcelas
   ‚úÖ Mostra "(d√©bito n√£o pode ser parcelado)"
   ‚úÖ Limpa bandeira
   ‚Üì
5Ô∏è‚É£ Aparece campo "Bandeira do Cart√£o" (DEPOIS!)
   ‚Üì
6Ô∏è‚É£ Usu√°rio seleciona bandeira (Visa, Master, Elo...)
   ‚Üì
7Ô∏è‚É£ Sistema calcula taxa de d√©bito
   ‚Üì
8Ô∏è‚É£ Preview mostra:
   Cliente paga:  R$ 100,00
   - Taxa (2.5%): R$ 2,50
   Voc√™ recebe:   R$ 97,50
```

---

### **Fluxo 2: Pagamento com Cr√©dito Parcelado**

```
1Ô∏è‚É£ Usu√°rio seleciona forma de pagamento que permite parcelamento
   ‚Üì
2Ô∏è‚É£ Usu√°rio seleciona: 3 parcelas
   ‚Üì
3Ô∏è‚É£ Aparece campo "Tipo de Transa√ß√£o"
   Op√ß√µes dispon√≠veis:
   - D√©bito
   - Cr√©dito Parcelado (3x) ‚úÖ (pois parcelasMax > 1)
   - PIX (se maquininha aceita)
   ‚Üì
4Ô∏è‚É£ Usu√°rio seleciona: "Cr√©dito Parcelado (3x)"
   ‚Üì
5Ô∏è‚É£ Aparece campo "Bandeira do Cart√£o"
   (mostra apenas bandeiras com taxa configurada para 3x)
   ‚Üì
6Ô∏è‚É£ Usu√°rio seleciona bandeira
   ‚Üì
7Ô∏è‚É£ Sistema calcula taxa de cr√©dito parcelado 3x
   ‚Üì
8Ô∏è‚É£ Preview mostra:
   Cliente paga:  R$ 300,00
   - Taxa (5.5%): R$ 16,50
   Voc√™ recebe:   R$ 283,50
   Parcelas:      3x de R$ 94,50
```

---

### **Fluxo 3: Tentativa de Parcelar com Forma que N√£o Permite**

```
1Ô∏è‚É£ Usu√°rio seleciona forma de pagamento com parcelasMax = 1
   (Ex: "Dinheiro", "Boleto √† vista")
   ‚Üì
2Ô∏è‚É£ Campo de parcelas N√ÉO aparece (pois parcelasMax = 1)
   ‚Üì
3Ô∏è‚É£ Aparece "Tipo de Transa√ß√£o" (se for maquininha)
   Op√ß√µes dispon√≠veis:
   - D√©bito
   - Cr√©dito √† Vista ‚úÖ (√∫nica op√ß√£o de cr√©dito!)
   - ‚ùå Cr√©dito Parcelado N√ÉO APARECE (pois parcelasMax = 1)
   - PIX
```

---

## üß™ COMO TESTAR

### **Teste 1: D√©bito e PIX (n√£o parcelam)**

```bash
# Teste D√©bito:
1. V√° em uma venda
2. Registrar Pagamento
3. Selecione forma vinculada a maquininha
4. Valor: R$ 100
5. Parcelas: 2x (apenas para testar)
6. Tipo de Transa√ß√£o: selecione "D√©bito"
7. Verificar:
   ‚úÖ Campo "Parcelas" volta para 1x automaticamente
   ‚úÖ Campo "Parcelas" fica desabilitado (cinza)
   ‚úÖ Mensagem: "(d√©bito n√£o pode ser parcelado)"
   ‚úÖ Campo "Bandeira" aparece DEPOIS do tipo

# Teste PIX:
1. Parcelas: 2x (apenas para testar)
2. Tipo de Transa√ß√£o: selecione "PIX"
3. Verificar:
   ‚úÖ Campo "Parcelas" volta para 1x automaticamente
   ‚úÖ Campo "Parcelas" fica desabilitado (cinza)
   ‚úÖ Mensagem: "(PIX n√£o pode ser parcelado)"
   ‚úÖ Campo "Bandeira" N√ÉO aparece (PIX n√£o precisa)
```

---

### **Teste 2: Cr√©dito Parcelado (valida parcelasMax)**

```bash
# Cen√°rio A: Forma permite parcelamento (parcelasMax = 12)
1. Selecione forma com parcelasMax > 1
2. Parcelas: 3x
3. Tipo de Transa√ß√£o:
   ‚úÖ Mostra "Cr√©dito Parcelado (3x)"
4. Selecione cr√©dito parcelado
5. Bandeira aparece DEPOIS
6. Sistema calcula taxa correta

# Cen√°rio B: Forma N√ÉO permite parcelamento (parcelasMax = 1)
1. Selecione forma com parcelasMax = 1
2. Campo "Parcelas" N√ÉO aparece
3. Tipo de Transa√ß√£o:
   ‚úÖ Mostra "Cr√©dito √† Vista"
   ‚ùå N√ÉO mostra "Cr√©dito Parcelado"
```

---

### **Teste 3: Ordem dos Campos**

```bash
1. Selecione forma vinculada a maquininha
2. Verificar ordem:
   1¬∫: Tipo de Transa√ß√£o ‚úÖ
   2¬∫: Bandeira do Cart√£o ‚úÖ (s√≥ aparece DEPOIS de selecionar tipo)
3. Selecione "PIX"
4. Verificar:
   ‚úÖ Campo "Bandeira" desaparece (PIX n√£o precisa)
```

---

## ‚úÖ CHECKLIST DE VALIDA√á√ÉO

- [x] Tipo de Transa√ß√£o aparece ANTES da Bandeira
- [x] Bandeira s√≥ aparece DEPOIS de selecionar tipo
- [x] Bandeira n√£o aparece para PIX
- [x] D√©bito trava parcelas em 1x automaticamente
- [x] PIX trava parcelas em 1x automaticamente
- [x] Campo de parcelas fica desabilitado quando d√©bito ou PIX
- [x] Mensagem "(d√©bito n√£o pode ser parcelado)" aparece
- [x] Mensagem "(PIX n√£o pode ser parcelado)" aparece
- [x] Cr√©dito √† Vista s√≥ aparece se numeroParcelas = 1
- [x] Cr√©dito Parcelado s√≥ aparece se numeroParcelas > 1 E parcelasMax > 1
- [x] Ao selecionar d√©bito ou PIX, limpa bandeira e for√ßa rec√°lculo

---

## üéØ RESUMO DAS MUDAN√áAS

### **Template:**

- ‚úÖ Invertida ordem: Tipo ‚Üí Bandeira
- ‚úÖ Bandeira s√≥ aparece se tipo selecionado e n√£o for PIX
- ‚úÖ Campo de parcelas desabilitado quando d√©bito
- ‚úÖ Mensagem informativa quando d√©bito

### **Script:**

- ‚úÖ Adicionado: `podeUsarCreditoAVista` computed
- ‚úÖ Adicionado: `podeUsarCreditoParcelado` computed
- ‚úÖ Modificado: Watcher de `tipoTransacaoManual` para travar parcelas em d√©bito

### **Comportamento:**

- ‚úÖ D√©bito e PIX for√ßam 1x automaticamente
- ‚úÖ Cr√©dito parcelado valida `parcelasMax`
- ‚úÖ Ordem l√≥gica dos campos (tipo ‚Üí bandeira)
- ‚úÖ Feedback visual claro (desabilitado = cinza)
- ‚úÖ Mensagens informativas espec√≠ficas para cada tipo

---

## üìù ARQUIVOS MODIFICADOS

### **Frontend:**

- ‚úÖ `VendaDetalhesView.vue`
  - Template: Ordem dos campos invertida (tipo ‚Üí bandeira)
  - Template: Campo de parcelas com `:disabled` para d√©bito e PIX
  - Template: Mensagens informativas para d√©bito e PIX
  - Template: Valida√ß√µes `v-if` nos tipos de cr√©dito
  - Script: Computed `podeUsarCreditoAVista`
  - Script: Computed `podeUsarCreditoParcelado`
  - Script: Watcher `tipoTransacaoManual` (trava parcelas em d√©bito e PIX)

---

**UX de Maquininha melhorada! Ordem l√≥gica + D√©bito e PIX n√£o parcelam mais! üé®**

**Recarregue a p√°gina (F5) para ver as mudan√ßas! üöÄ**
